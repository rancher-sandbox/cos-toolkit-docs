<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.82.0"><link rel=canonical type=text/html href=https://mudler.github.io/cos-toolkit-docs/docs/creating-derivatives/><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=https://mudler.github.io/cos-toolkit-docs/favicons/favicon.ico><link rel=apple-touch-icon href=https://mudler.github.io/cos-toolkit-docs/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=https://mudler.github.io/cos-toolkit-docs/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=https://mudler.github.io/cos-toolkit-docs/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://mudler.github.io/cos-toolkit-docs/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=https://mudler.github.io/cos-toolkit-docs/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=https://mudler.github.io/cos-toolkit-docs/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=https://mudler.github.io/cos-toolkit-docs/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=https://mudler.github.io/cos-toolkit-docs/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=https://mudler.github.io/cos-toolkit-docs/favicons/android-192x192.png sizes=192x192><title>Creating derivatives | cOS toolkit</title><meta property="og:title" content="Creating derivatives"><meta property="og:description" content="Documents various methods for creating cOS derivatives
"><meta property="og:type" content="website"><meta property="og:url" content="https://mudler.github.io/cos-toolkit-docs/docs/creating-derivatives/"><meta property="og:site_name" content="cOS toolkit"><meta itemprop=name content="Creating derivatives"><meta itemprop=description content="Documents various methods for creating cOS derivatives
"><meta name=twitter:card content="summary"><meta name=twitter:title content="Creating derivatives"><meta name=twitter:description content="Documents various methods for creating cOS derivatives
"><link rel=preload href=https://mudler.github.io/cos-toolkit-docs/scss/main.min.ac0063411fe78d136ba4542d07957ba8f37593d6f775a519095995a04a05a1a6.css as=style><link href=https://mudler.github.io/cos-toolkit-docs/scss/main.min.ac0063411fe78d136ba4542d07957ba8f37593d6f775a519095995a04a05a1a6.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=https://mudler.github.io/cos-toolkit-docs/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">cOS toolkit</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=https://mudler.github.io/cos-toolkit-docs/docs/><span class=active>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=https://mudler.github.io/cos-toolkit-docs/docs/creating-derivatives/>Return to the regular view of this page</a>.</p></div><h1 class=title>Creating derivatives</h1><div class=lead>Documents various methods for creating cOS derivatives</div><ul><li>1: <a href=#pg-c76daa64bd1164d9a6d538211f0fa16b>Creating bootable images</a></li><li>2: <a href=#pg-a6da0d82df260d9d3eb54396d771d6ec>Build AMI machines for AWS</a></li><li>3: <a href=#pg-cd433442ed594a947415a78b992b535e>Creating derivatives</a></li></ul><div class=content><p>All the documentation below imply that the container image generated will be the booting one, there are however several configuration entrypoint that you should keep in mind while building the image which are general across all the implementation:</p><ul><li>Custom persistent runtime configuration has to be provided in <code>/system/oem</code> for derivatives. Everything under <code>/system/oem</code> will be loaded during the various stages (boot, network, initramfs). You can check <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/e411d8b3f0044edffc6fafa39f3097b471ef46bc/packages/cloud-config/oem>here</a> for the <code>cOS</code> defaults. See <code>00_rootfs.yaml</code> to customize the booting layout.</li><li><code>/etc/cos/bootargs.cfg</code> contains the booting options required to boot the image with GRUB</li><li><code>/etc/cos-upgrade-image</code> contains the default upgrade configuration for recovery and the booting system image</li></ul><p>Derivatives inherits <code>cOS</code> defaults, which you can override during the build process.</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c76daa64bd1164d9a6d538211f0fa16b>1 - Creating bootable images</h1><div class=lead>This document describes the requirements to create standard container images that can be used for <code>cOS</code> deployments</div><p>It&rsquo;s possible to create standard container images which are consumable by the vanilla <code>cOS</code> images (ISO, Cloud Images, etc.) during the upgrade and deploy phase.</p><p>This allows anyone to create bootable images by just building and publishing a container image with the usual container workflow. The image have to contain parts of the cos-toolkit in order to be bootable, an illustrative example can be:</p><pre><code>ARG LUET_VERSION=0.16.7

FROM quay.io/luet/base:$LUET_VERSION AS luet

FROM opensuse/leap:15.3
ARG ARCH=amd64
ENV ARCH=${ARCH}
RUN zypper in -y ...

RUN luet install -y \
    toolchain/yip \
    utils/installer \
    system/cos-setup \
    system/immutable-rootfs \
    system/grub-config \
    system/cloud-config \
    utils/k9s \
    utils/nerdctl

...
</code></pre><p>The workflow would be then:</p><ol><li><code>docker build</code> the image</li><li><code>docker push</code> the image to some registry</li><li><code>cos-upgrade --docker-image --no-verify $IMAGE</code> from a cOS machine</li></ol><p>You can explore more examples in the <a href=../../examples/creating_bootable_images>example folder</a> on how to create bootable images</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a6da0d82df260d9d3eb54396d771d6ec>2 - Build AMI machines for AWS</h1><div class=lead>This section documents the procedure to deploy cOS (or derivatives) images in AWS public cloud provider by using the cOS Vanilla image.</div><p>Requirements:</p><ul><li>Packer</li><li>AWS access keys with the appropriate roles and permissions</li><li>A Vanilla AMI</li></ul><p>The suggested approach is based on using Packer templates to customize the
deployment and automate the upload and publish to AWS. For all the details
and possibilties of Packer check the <a href=https://www.packer.io/guides/hcl>official documentation</a>.</p><h2 id=run-the-build-with-packer>Run the build with Packer</h2><p>Publishing an AMI image in AWS based on top of the latest cOS Vanilla image is
fairly simple. In fact, it is only needed to set the AWS credentials
and run a <code>packer build</code> process to trigger the deployment and register the
resulting snapshot as an AMI. In such case the lastest cOS image will be
deployed and configured with pure defaults. Consider:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>export</span> <span style=color:#000>AWS_ACCESS_KEY_ID</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_aws_access_key&gt; 
&gt; <span style=color:#204a87>export</span> <span style=color:#000>AWS_SECRET_ACCESS_KEY</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_aws_secret_access_key&gt; 
&gt; <span style=color:#204a87>export</span> <span style=color:#000>AWS_DEFAULT_REGION</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_aws_default_region&gt;

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -only amazon-ebs.cos .
</code></pre></div><p>AWS keys can be passed as environment variables as it is above or packer
picks them from aws-cli configuration files (<code>~/.aws</code>) if any. Alternatively,
one can define them in the variables file.</p><p>The <code>-only amazon-ebs.cos</code> flag is just to tell packer which of the sources
to make use for the build. Note the <code>packer/images.json.pkr.hcl</code> file defines
few other sources such as <code>qemu</code> and <code>virtualbox</code>.</p><h2 id=customize-the-build-with-a-variables-file>Customize the build with a variables file</h2><p>The packer template can be customized with the variables defined in
<code>packer/variables.pkr.hcl</code>. These are the variables that can be set on run
time using the <code>-var key=value</code> or <code>-var-file=path</code> flags. The variable file
can be a json file including desired varibles. Consider the following example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the packer folder of the cOS-toolkit repository checkout</span>

&gt; cat <span style=color:#4e9a06>&lt;&lt; EOF &gt; test.json
</span><span style=color:#4e9a06>{
</span><span style=color:#4e9a06>    &#34;aws_cos_install_args&#34;: &#34;cos-deploy&#34;,
</span><span style=color:#4e9a06>    &#34;aws_launch_volume_size&#34;: 16,
</span><span style=color:#4e9a06>    &#34;name&#34;: &#34;MyTest&#34;
</span><span style=color:#4e9a06>}
</span><span style=color:#4e9a06>EOF</span>

&gt; packer build -only amazon-ebs.cos -var-file<span style=color:#ce5c00;font-weight:700>=</span>test.json .
</code></pre></div><p>The above example runs the AMI Vanilla image on a 16GiB disk and calls the
command <code>cos-deploy</code> to deploy the main OS, once deployed an snapshot is
created and an AMI out this snapshot is registered in EC2. The created
AMI artifact will be called <code>MyTest</code>, the name has no impact in the underlaying
OS.</p><h3 id=available-variables-for-customization>Available variables for customization</h3><p>All the customizable variables are listed in <code>packer/variables.pkr.hcl</code>,
variables with the <code>aws_</code> prefix are the ones related to the AWS Packer
template. These are some of the relevant ones:</p><ul><li><p><code>aws_cos_install_args</code>: This the command that will be executed once the
Vanilla image booted. In this stage it is expected that user sets a command
to install the desired cOS or derivative image. By default it is set to
<code>cos-deploy</code> which will deploy the latest cOS image in cOS repositories.
To deploy custom derivatives something like
<code>cos-deploy --docker-image &lt;my-derivative-img-ref></code> should be sufficient.</p></li><li><p><code>aws_launch_volume_size</code>: This sets the disk size of the VM that Packer
launches for the build. During Vanilla image first boot the system will
expand to the disk geometry. The layout is configurable with the user-data.</p></li><li><p><code>aws_user_data_file</code>: This sets the user-data file that will be used for the
aws instance during the build process. It defaults to <code>aws/setup-disk.yaml</code> and
the defauklt file basically includes the disk expansion configuration. It
adds a <code>COS_STATE</code> partition that should be big enough to store about three times
the size of the image to deploy. Then it also creates a <code>COS_PERSISTENT</code>
partition with all the rest of the available space in disk.</p></li><li><p><code>aws_source_ami_filter_name</code>: This a filter to choose the AMI image for the
build process. It defaults to <code>*cOS*Vanilla*</code> pattern to pick the latest cOS
Vanilla image available.</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-cd433442ed594a947415a78b992b535e>3 - Creating derivatives</h1><div class=lead>This document summarize references to create derivatives with <code>cos-toolkit</code> by using the <code>luet</code> toolchain.</div><p><code>cos-toolkit</code> is a manifest to share a common abstract layer between derivatives inheriting the same <a href=https://mudler.github.io/cos-toolkit-docs/docs/derivatives_featureset.md>featureset</a>.</p><p><code>cos</code> is a <a href=https://luet-lab.github.io/docs/docs/concepts/packages/specfile/#specfiles>Luet tree</a> and derivatives are Luet trees as well that inherit part of the compilation specs from <code>cos</code>.</p><p>Those trees are then post-processed and converted to Dockerfiles when building packages, that in turn are used to build docker images and final artefacts.</p><h2 id=high-level-workflow>High level workflow</h2><p>The building workflow can be resumed in the following steps:</p><ul><li>Build packages from container images. This step generates build metadata (<code>luet build</code> / <code>docker build</code> / <code>buildah</code> ..)</li><li>Add repository metadata and create a repository from the build phase (<code>luet create-repo</code>)</li><li>(otherwise, optionally) publish the repository and the artefacts along (<code>luet create-repo --push-images</code>)</li></ul><p>While on the client side, the upgrade workflow is:</p><ul><li><code>luet install</code> (when upgrading from release channels) latest cos on a pristine image file</li><li>or <code>luet util unpack</code> (when upgrading from specific docker images)</li></ul><p><em>Note</em>: The manual build steps are not stable and will likely change until <a href=https://github.com/rancher-sandbox/cOS-toolkit/issues/108>we build a single CLI</a> to encompass the <code>cos-toolkit</code> components, rather use <code>source .envrc && cos-build</code> for the moment being while iterating locally.</p><h2 id=example>Example</h2><p><a href=https://github.com/rancher-sandbox/cos-toolkit-sample-repo>The sample repository</a> has the following layout:</p><pre><code>├── Dockerfile
├── .envrc
├── .github
│   └── workflows
│       ├── build.yaml
│       └── test.yaml
├── .gitignore
├── iso.yaml
├── LICENSE
├── .luet.yaml
├── Makefile
├── packages
│   ├── sampleOS
│   │   ├── 02_upgrades.yaml
│   │   ├── 03_branding.yaml
│   │   ├── 04_accounting.yaml
│   │   ├── build.yaml
│   │   ├── definition.yaml
│   │   └── setup.yaml
│   └── sampleOSService
│       ├── 10_sampleOSService.yaml
│       ├── build.yaml
│       ├── definition.yaml
│       └── main.go
└── README.md
</code></pre><p>In the detail:</p><ul><li>the <code>packages</code> directory is the sample Luet tree that contains the <a href=https://luet-lab.github.io/docs/docs/concepts/packages/specfile/#build-specs>package definitions</a> [1] which composes the derivative.
For an overview of the package syntax and build process, see the <a href=https://luet-lab.github.io/docs/docs/concepts/packages/>official luet documentation</a></li><li><code>.luet.yaml</code> contains a configuration file for <code>luet</code> pointing to the <code>cos</code> repositories, used to fetch packages required in order to build the iso [2] <strong>and</strong> to fetch definitions from [3].</li><li><code>Makefile</code> and <code>.envrc</code> are just wrappers around <code>luet build</code> and <code>luet create-repo</code></li><li><code>iso.yaml</code> a YAML file that describes what packages to embed in the final ISO</li></ul><p><em>Note</em>: There is nothing special in the layout, and neither the <code>packages</code> folder naming is special. By convention we have chosen to put the compilation specs in the <code>packages</code> folder, the <code>Makefile</code> is just calling <code>luet</code> with a set of default parameters according to this setup.</p><p>The <code>.envrc</code> is provided as an example to automatize the build process: it will build a docker image with the required dependencies, check the <a href=https://mudler.github.io/cos-toolkit-docs/docs/dev.md>development docs</a> about the local requirements if you plan to build outside of docker.</p><p><strong>[1]</strong> <em>In the sample above we just declare two packages: <code>sampleOS</code> and <code>sampleOSService</code>. Their metadata are respectively in <code>packages/sampleOS/definition.yaml</code> and <code>packages/sampleOSService/definition.yaml</code></em></p><p><strong>[2]</strong> <em>We consume <code>live/systemd-boot</code> and <code>live/syslinux</code> from <code>cos</code> instead of building them from the sample repository</em></p><p><strong>[3]</strong> <em>see also <a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample#main-difference-with-cos-toolkit-sample-repo>using git submodules</a> instead</em></p><h2 id=single-image-os>Single image OS</h2><p>Derivatives are composed by a combination of specs to form a final package that is consumed as a single image OS.</p><p>The container image during installation and upgrade, is converted to an image file with a backing ext2 fs.</p><p>In the sample repository <a href=https://github.com/rancher-sandbox/cos-toolkit-sample-repo/blob/master/packages/sampleOS/definition.yaml>we have defined <code>system/sampleOS</code></a> as our package, that will later on will be converted to image.</p><p>Packages in luet have <code>runtime</code> and <code>buildtime</code> specifications into <code>definition.yaml</code> and <code>build.yaml</code> respectively, and in the buildtime we set:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>join</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;system&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cos&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&gt;=0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;app&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;sampleOSService&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&gt;=0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>This instruct <code>luet</code> to compose a new image from the results of the compilation of the specified packages, without any version constraints, and use it to run any <code>steps</code> and <code>prelude</code> on top of it.</p><p>We later run arbitrary steps to tweak the image:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>steps</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>And we instruct luet to compose the final artifact as a <code>squash</code> of the resulting container image, composed of all the files:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>unpack</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>A detailed explaination of all the keywords available <a href=https://luet-lab.github.io/docs/docs/concepts/packages/specfile/#keywords>is in the luet docs</a> along with the <a href=https://luet-lab.github.io/docs/docs/concepts/packages/specfile/#building-strategies>supported build strategies</a>.</p><p>We exclude then a bunch of file that we don&rsquo;t want to be in the final package (regexp supported):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>excludes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>Note</strong>: In the <a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample/blob/19c530ea53ad577e60adbae1d419781fcea808f5/packages/epinioOS/build.yaml#L1>EpinioOS sample</a>, we use <code>requires</code> instead of <code>join</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>requires</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;system&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cos&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&gt;=0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;k3s&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;app&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&gt;=0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;policy&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;selinux&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&gt;=0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>The difference is that with <code>requires</code> we use the <em>building</em> container that was used to build the packages instead of creating a new image from their results: we are not consuming their artifacts in this case, but the environment used to build them. See also <a href=https://luet-lab.github.io/docs/docs/concepts/packages/specfile/#package-source-image>the luet docs</a> for more details.</p><h3 id=building>Building</h3><p>Refering to the <code>sampleOS</code> example, we set the <a href=https://github.com/rancher-sandbox/cos-toolkit-sample-repo/blob/8ed369c6ca76f1fc69e49d8001c689c8d0371d30/Makefile#L13>Makefile</a> accordingly to compile the system package.</p><p>With luet installed locally and docker running, in your git checkout you can build it also by running <code>luet build --tree packages system/sampleOS</code>. This will produce an artifact of <code>system/sampleOS</code>. Similary, we could also build separately the sample application with <code>luet build --tree packages app/sampleOSService</code>.</p><p>The build process by default results in a <code>build</code> folder containing the package and the compilation metadata in order to generate a repository.</p><p><em>Note on reproducibility</em>: See <a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample#main-difference-with-cos-toolkit-sample-repo>the difference between our two samples repositories</a> for an explanation of what are the implications of using a <code>.luet.yaml</code> file for building instead of a git submodule.</p><h2 id=additional-packages>Additional packages</h2><p>In our sample repo we have split the logic of a separate application in <code>app/sampleOSService</code>.</p><p><code>sampleOSService</code> is just an HTTP server that we would like to have permanently in the system and on boot.</p><p>Thus we define it as a dependency in the <code>system/sampleOS</code>&rsquo;s <code>requires</code> section:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>requires</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;app&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;sampleOSService&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&gt;=0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><em>Note</em> If you are wondering about copying just single files, there is <a href=https://github.com/mudler/luet/issues/190>an upstream open issue</a> about it.</p><p>In this way, when building our <code>sampleOS</code> package, <code>luet</code> will automatically apply the compilation spec of our package on top.</p><h2 id=templating>Templating</h2><p>The package <code>build</code> definition supports <a href=https://luet-lab.github.io/docs/docs/concepts/packages/templates/>templating</a>, and global interpolation of build files with multiple values files.</p><p>Values file can be specified during build time in luet with the <code>--values</code> flag (also multiple files are allowed) and, if you are familiar with <code>helm</code> it using the same engine under the hood, so all the functions are available as well.</p><p><code>cos-toolkit</code> itself uses <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/values>default values files</a> for every supported distributions.</p><p>For a more complex example involving values file, <a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample>see the epinio appliance example</a>.</p><p>Templates uses cases are for: resharing common pieces between flavors, building for different platforms and architectures, &mldr;</p><h2 id=upgrades>Upgrades</h2><p>In order for the derivative to upgrade, it needs to be configured in order to download upgrades from a source.</p><p>By default, <code>cos</code> derivatives if not specified will point to latest <code>cos-toolkit</code>. To override, you need to or overwrite the content of <code>/system/oem/02_upgrades.yaml</code> or supply an additional one, e.g. <code>/system/oem/03_upgrades.yaml</code> in the final image, see <a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample/blob/master/packages/epinioOS/02_upgrades.yaml>an example here</a>.</p><p>The configuration need to point to a specific docker image or an upgrade channel, <a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample#images>a complete example and documentation is here</a>.</p><h2 id=oem-customizations>OEM Customizations</h2><p>There are several way to customize a cos-toolkit derivative:</p><ul><li>declaratively in runtime with cloud-config file (by overriding, or extending)</li><li>stateful, via build definition when running <code>luet build</code>.</li></ul><p>For runtime persistence configuration, the only supported way is with cloud-config files, <a href=https://github.com/rancher-sandbox/cOS-toolkit/blob/master/docs/derivatives_featureset.md#persistent-changes>see the relevant docs</a>.</p><p>A derivative automatically loads and executes cloud-config files which are hooking into system stages.</p><p>In this way the cloud-config mechanism works also as an emitter event pattern - running services or programs can emit new custom <code>stages</code> in runtime by running <code>cos-setup stage_name</code>.</p><p>For an extensive list of the default OEM files that can be reused or replaced <a href=https://github.com/rancher-sandbox/cOS-toolkit/blob/master/docs/derivatives_featureset.md#oem-customizations>see here</a>.</p><h2 id=customizing-grub-boot-cmdline>Customizing GRUB boot cmdline</h2><p>Each bootable image have a default boot arguments which are defined in <code>/etc/cos/bootargs.cfg</code>. This file is used by GRUB to parse the cmdline used to boot the image.</p><p>For example:</p><pre><code>set kernel=/boot/vmlinuz
if [ -n &quot;$recoverylabel&quot; ]; then
    # Boot arguments when the image is used as recovery
    set kernelcmd=&quot;console=tty1 root=live:CDLABEL=$recoverylabel rd.live.dir=/ rd.live.squashimg=$img panic=5&quot;
else
    # Boot arguments when the image is used as active/passive
    set kernelcmd=&quot;console=tty1 root=LABEL=$label iso-scan/filename=$img panic=5 security=selinux selinux=1&quot;
fi

set initramfs=/boot/initrd
</code></pre><p>You can tweak that file to suit your needs if you need to specify persistent boot arguments.</p><h2 id=separate-image-recovery>Separate image recovery</h2><p>A separate image recovery can be used during upgrades.</p><p>To set a default recovery image or a package, set <code>RECOVERY_IMAGE</code> into /etc/cos-upgrade-image. It allows to override the default image/package used during upgrades.</p><p>To make an ISO with a separate recovery image as squashfs, you can either use the default from <code>cOS</code>, by adding it in the iso yaml file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>recovery/cos-img</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>The installer will detect the squashfs file in the iso, and will use it when installing the system. You can customize the recovery image as well by providing your own: see the <code>recovery/cos-img</code> package definition as a reference.</p><h2 id=building-isos-vagrant-boxes-ova>Building ISOs, Vagrant Boxes, OVA</h2><p>In order to build an iso at the moment of writing, we first rely on <a href=https://github.com/mudler/luet-makeiso>luet-makeiso</a>. It accepts a YAML file denoting the packages to bundle in an ISO and a list of luet repositories where to download the packages from.</p><p>A sample can be found <a href=https://github.com/rancher-sandbox/cos-toolkit-sample-repo/blob/master/iso.yaml>here</a>.</p><p>To build an iso from a local repository (the build process, automatically produces a repository in <code>build</code> in the local checkout):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>luet-makeiso ./iso.yaml --local build
</code></pre></div><p>Where <code>iso.yaml</code> is the iso specification file, and <code>--local build</code> is an optional argument to use also the local repository in the build process.</p><p>We are then free to refer to packages in the tree in the <code>iso.yaml</code> file.</p><p>For Vagrant Boxes, OVA and QEMU images at the moment of writing we are relying on <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>packer templates</a>.</p><h2 id=known-issues>Known issues</h2><p>When building cOS or a cOS derivative, you could face different issues, this section provides a description of the most known ones, and way to workaround them.</p><h3 id=building-selinux-fails>Building SELinux fails</h3><p><code>cOS</code> by default has SELinux enabled in permissive mode. If you are building parts of cOS or cOS itself from scratch, you might encounter issues while building the SELinux module, like so:</p><pre><code>Step 12/13 : RUN checkmodule -M -m -o cOS.mod cOS.te &amp;&amp; semodule_package -o cOS.pp -m cOS.mod
  ---&gt; Using cache
 ---&gt; 1be520969ead
Step 13/13 : RUN semodule -i cOS.pp
  ---&gt; Running in c5bfa5ae92e2
 libsemanage.semanage_commit_sandbox: Error while renaming /var/lib/selinux/targeted/active to /var/lib/selinux/targeted/previous. (Invalid cross-device link).
semodule:  Failed!
 The command '/bin/sh -c semodule -i cOS.pp' returned a non-zero code: 1
 Error: while resolving join images: failed building join image: Failed compiling system/selinux-policies-0.0.6+3: failed building package image: Could not push image: raccos/sampleos:ffc8618ecbfbffc11cc3bca301cc49867eb7dccb623f951dd92caa10ced29b68 selinux-policies-system-0.0.6+3.dockerfile: Could not build image: raccos/sampleos:ffc8618ecbfbffc11cc3bca301cc49867eb7dccb623f951dd92caa10ced29b68 selinux-policies-system-0.0.6+3.dockerfile: Failed running command: : exit status 1
 Bailing out
make: *** [Makefile:45: build] Error 1
</code></pre><p>The issue is possibly caused by <a href=https://github.com/docker/for-linux/issues/480>https://github.com/docker/for-linux/issues/480</a> . A workaround is to switch the storage driver of Docker. Check if your storage driver is overlay2, and switch it to <code>devicemapper</code></p><h3 id=multi-stage-copy-build-fails>Multi-stage copy build fails</h3><p>While processing images with several stage copy, you could face the following:</p><pre><code> 🐋  Building image raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d done
 📦  8/8 system/cos-0.5.3+1 ⤑ 🔨  build system/selinux-policies-0.0.6+3 ✅  Done
 🚀  All dependencies are satisfied, building package requested by the user system/cos-0.5.3+1
 📦  system/cos-0.5.3+1  Using image:  raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d
 📦  system/cos-0.5.3+1 🐋  Generating 'builder' image from raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d as raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed with prelude steps
🚧  warning Failed to download 'raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed'. Will keep going and build the image unless you use --fatal
🚧  warning Failed pulling image: Error response from daemon: manifest for raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed not found: manifest unknown: manifest unknown
: exit status 1
 🐋  Building image raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed
 Sending build context to Docker daemon  9.728kB
 Step 1/10 : FROM raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d
  ---&gt; f1122e79b17e
Step 2/10 : COPY . /luetbuild
  ---&gt; 4ff3e202951b
 Step 3/10 : WORKDIR /luetbuild
  ---&gt; Running in 7ec571b96c6f
 Removing intermediate container 7ec571b96c6f
  ---&gt; 9e05366f830a
Step 4/10 : ENV PACKAGE_NAME=cos
  ---&gt; Running in 30297dbd21a3
 Removing intermediate container 30297dbd21a3
  ---&gt; 4c4838b629f4
 Step 5/10 : ENV PACKAGE_VERSION=0.5.3+1
  ---&gt; Running in 36361b617252
 Removing intermediate container 36361b617252
  ---&gt; 6ac0d3a2ff9a
Step 6/10 : ENV PACKAGE_CATEGORY=system
  ---&gt; Running in f20c2cf3cf34
 Removing intermediate container f20c2cf3cf34
  ---&gt; a902ff95d273
 Step 7/10 : COPY --from=quay.io/costoolkit/build-cache:f3a333095d9915dc17d7f0f5629a638a7571a01dcf84886b48c7b2e5289a668a /usr/bin/yip /usr/bin/yip
  ---&gt; 42fa00d9c990
 Step 8/10 : COPY --from=quay.io/costoolkit/build-cache:e3bbe48c6d57b93599e592c5540ee4ca7916158461773916ce71ef72f30abdd1 /usr/bin/luet /usr/bin/luet
 e3bbe48c6d57b93599e592c5540ee4ca7916158461773916ce71ef72f30abdd1: Pulling from costoolkit/build-cache
 3599716b36e7:  Already exists
 24a39c0e5d06: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 378615c429f5: Already exists
 c28da22d3dfd:  Already exists
 ddb4dd5c81b0: Already exists
 92db41c0c9ab: Already exists
 4f4fb700ef54: Already exists
 6e0ca71a6514: Already exists
 47debb886c7d: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 d0c9d0f8ddb6: Already exists
 e5a48f1f72ad:  Pulling fs layer
 4f4fb700ef54:  Pulling fs layer
 7d603b2e4a37:  Pulling fs layer
 64c4d787e344:  Pulling fs layer
 f8835d2e60d1:  Pulling fs layer
 64c4d787e344:  Waiting
 f8835d2e60d1:  Waiting
 e5a48f1f72ad:  Download complete
 e5a48f1f72ad:  Pull complete
 4f4fb700ef54:  Verifying Checksum
 4f4fb700ef54:  Download complete
 4f4fb700ef54:  Pull complete
 7d603b2e4a37: Verifying Checksum
7d603b2e4a37: Download complete
 64c4d787e344: Verifying Checksum
64c4d787e344: Download complete
 7d603b2e4a37: Pull complete
 64c4d787e344: Pull complete
 f8835d2e60d1:  Verifying Checksum
 f8835d2e60d1:  Download complete
 f8835d2e60d1: Pull complete
 Digest: sha256:9b58bed47ff53f2d6cc517a21449cae686db387d171099a4a3145c8a47e6a1e0
 Status: Downloaded newer image for quay.io/costoolkit/build-cache:e3bbe48c6d57b93599e592c5540ee4ca7916158461773916ce71ef72f30abdd1
 failed to export image: failed to create image: failed to get layer sha256:118537d8997a08750ab1ac3d8e8575e40fe60e8337e02633b0d8a1287117fe78: layer does not exist
 Error: while resolving join images: failed building join image: failed building package image: Could not push image: raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d cos-system-0.5.3+1-builder.dockerfile: Could not build image: raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d cos-system-0.5.3+1-builder.dockerfile: Failed running command: : exit status 1
 Bailing out
make: *** [Makefile:45: build] Error 1
</code></pre><p>There is a issue open <a href=https://github.com/moby/moby/issues/37965>upstream</a> about it. A workaround is to enable Docker buildkit with <code>DOCKER_BUILDKIT=1</code>.</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2021 SUSE LLC All Rights Reserved</small>
<small class=ml-1><a href=https://www.suse.com/company/legal/ target=_blank>Privacy Policy</a></small></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=https://mudler.github.io/cos-toolkit-docs/js/main.min.63db3e552bd0543be17ce4a79a18b744e9cb72256bec42b540e3ab0cd43722d0.js integrity="sha256-Y9s+VSvQVDvhfOSnmhi3ROnLciVr7EK1QOOrDNQ3ItA=" crossorigin=anonymous></script></body></html>