<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.82.0"><link rel=canonical type=text/html href=https://rancher-sandbox.github.io/cos-toolkit-docs/docs/><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/favicon.ico><link rel=apple-touch-icon href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-192x192.png sizes=192x192><title>Documentation | cOS toolkit</title><meta name=description content="cOS toolkit documentation website"><meta property="og:title" content="Documentation"><meta property="og:description" content="cOS toolkit documentation website"><meta property="og:type" content="website"><meta property="og:url" content="https://rancher-sandbox.github.io/cos-toolkit-docs/docs/"><meta property="og:site_name" content="cOS toolkit"><meta itemprop=name content="Documentation"><meta itemprop=description content="cOS toolkit documentation website"><meta name=twitter:card content="summary"><meta name=twitter:title content="Documentation"><meta name=twitter:description content="cOS toolkit documentation website"><link rel=preload href=https://rancher-sandbox.github.io/cos-toolkit-docs/scss/main.min.d0b55f70e257b0ca06b2d2738e9688ba828230001f6b752bce454708e74e1eed.css as=style><link href=https://rancher-sandbox.github.io/cos-toolkit-docs/scss/main.min.d0b55f70e257b0ca06b2d2738e9688ba828230001f6b752bce454708e74e1eed.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script><link rel=stylesheet href=https://rancher-sandbox.github.io/cos-toolkit-docs/css/prism.css></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=https://rancher-sandbox.github.io/cos-toolkit-docs/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">cOS toolkit</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=https://rancher-sandbox.github.io/cos-toolkit-docs/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/rancher-sandbox/cOS-toolkit/releases target=_blank><i class="fab fa-github"></i><span>Github releases</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=https://rancher-sandbox.github.io/cos-toolkit-docs/offline-search-index.465b92502a4b3ad7c6683771f7dff316.json data-offline-search-base-href=https://rancher-sandbox.github.io/cos-toolkit-docs/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-docs/docs/>Return to the regular view of this page</a>.</p></div><h1 class=title>Documentation</h1><ul><li>1: <a href=#pg-93aadc1aba179e6928539400a09b9e4e>Getting Started</a></li><ul><li>1.1: <a href=#pg-6d9b743260710738d7e98b374307931e>Download</a></li><li>1.2: <a href=#pg-20ed69725da67a67450fffe152e9dc9f>Booting</a></li><li>1.3: <a href=#pg-b8ae70d603defa5e6fa86ed3ac457356>Upgrading</a></li><li>1.4: <a href=#pg-116792d44b4b0a19cbac9a2d12b83ee4>Recovery</a></li></ul><li>2: <a href=#pg-4f8fa1d779276bb728601b46845a8df5>Customizing</a></li><ul><li>2.1: <a href=#pg-8637cd7f2ce65f4c97959f4d2a723eb9>Stages</a></li><li>2.2: <a href=#pg-80272a2426a531df16f16d019ccd6724>Persistency</a></li><li>2.3: <a href=#pg-4c6f31346340371adbb7fd2ceccc2e88>Login</a></li><li>2.4: <a href=#pg-72eef8ed52ca1d1dab6e21a58816bac9>OEM configuration</a></li><li>2.5: <a href=#pg-891dfa0a6f57b2aababf7ee877e38876>Upgrades</a></li><li>2.6: <a href=#pg-da6b91d86be15305a06525d5ddec51fc>GRUB</a></li></ul><li>3: <a href=#pg-5a2f2ae34ebe6581185222d4c362a1d2>Creating derivatives</a></li><ul><li>3.1: <a href=#pg-392e7921a89bd32cc9ec22ec800e2673>Package stack</a></li><li>3.2: <a href=#pg-c76daa64bd1164d9a6d538211f0fa16b>Creating bootable images</a></li><li>3.3: <a href=#pg-1c4b24f482e46235525d199eb0414f03>Build ISOs</a></li><li>3.4: <a href=#pg-a79e4c2576797b293b9be51f953489dd>Building images with Packer</a></li><ul><li>3.4.1: <a href=#pg-3919e113335b9645a5bc90d158baa902>Build AMI machines for AWS</a></li><li>3.4.2: <a href=#pg-053d994238218800fd0349937370b515>Build Images for Google Compute Platform</a></li><li>3.4.3: <a href=#pg-d123bd2dce21a42b3c3ca4afc4f353ad>Build QCOW, VirtualBox and Vagrant images</a></li></ul></ul><li>4: <a href=#pg-fb0f854c53f1ba28ad4c2ccf8d24df34>Examples</a></li><ul><li>4.1: <a href=#pg-69286228d8129cf393e95a7cae077086>Creating bootable images</a></li><li>4.2: <a href=#pg-4b878445954ea167a58c44cfb25c7dd2>Creating derivatives</a></li></ul><li>5: <a href=#pg-8dbd4e302cd86a4d0f71f71ce3b300de>Tutorials</a></li><ul><li>5.1: <a href=#pg-d57b80651f0651da95da0184bb71b5ba>K3s + Fleet</a></li><li>5.2: <a href=#pg-7f6aed5f776c4254888a6bcd3e601087>Trigger upgrades with K3s and Fleet</a></li></ul><li>6: <a href=#pg-8df6ea6904416b571ff9bc73afb50933>Reference</a></li><ul><li>6.1: <a href=#pg-533eb9e0a241df35bd13c7d531fc6bd3>Cloud-init support</a></li><li>6.2: <a href=#pg-a613d9ac188d10fa2f1061ed6e241893>Derivatives featureset</a></li><li>6.3: <a href=#pg-bd2c7a111cdf07391221b169f69faaa1>Known issues</a></li><li>6.4: <a href=#pg-cf896bdd96bc95a1c5079a49e2dd0b00>Immutable Root Filesystem</a></li><li>6.5: <a href=#pg-52dc75d922e47809f6e4b3a9ac43e7a8>High level architecture</a></li></ul><li>7: <a href=#pg-39f3813de34ce5cae320697c88e2a917>Development</a></li><ul><li>7.1: <a href=#pg-8a9a15a61c107bad2b137d10597cb9e8>Build Raw images</a></li><li>7.2: <a href=#pg-b891fcefc8f5da3d313248bffe32998d>Build requirements</a></li></ul></ul><div class=content><h2 id=what-is-cos>What is cOS?</h2><p>cOS is a toolkit which allows container images to be bootable in VMs, baremetals, embedded devices, and much more.</p><p>cOS allows to create meta-Linux derivatives which are configured throuought cloud-init configuration files and are immutable by default.</p><p>cOS and derivatives shares a common featureset, can be upgraded in a OTA-alike style, and upgrades are delivered with standard container registries.</p><p>cOS comes also with vanilla images that can be used to boot directly container images built with the toolkit.</p><h2 id=why-cos>Why cOS?</h2><p>cOS allows to create custom OS versions in your cluster with standard container images with a high degree of customization. It can also be used in its vanilla form - cOS enables then everyone to build their own derivative and access it in various formats. It&rsquo;s like &ldquo;Ventoy&rdquo; for persistent systems.</p><p>To build a bootable image is as simple as running <code>docker build</code>.</p><ul><li><p><strong>What is it good for?</strong>: Embedded, Cloud, Containers, VM, Baremetals, Servers, IoT, Edge</p></li><li><p><strong>What is it not good for?</strong>: Workstations (?), Gaming,</p></li></ul><h2 id=design-goals>Design goals</h2><ul><li>A Manifest for container-based OS. It contains just the common bits to make a container image bootable and to be upgraded from, with few customization on top</li><li>Immutable-first, but with a flexible layout</li><li>Cloud-init driven</li><li>Based on systemd</li><li>Built and upgraded from containers - It is a <a href=https://quay.io/repository/costoolkit/releases-green>single image OS</a>!</li><li>OTA updates</li><li>Easy to customize</li><li>Cryptographically verified</li><li>instant switch from different versions</li><li>recovery mechanism with <code>cOS</code> vanilla images (or bring your own)</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-93aadc1aba179e6928539400a09b9e4e>1 - Getting Started</h1><div class=lead>Getting started with cOS</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vRSuocC4_2rHeJAWW2vqinw_EZeZxTzJFo5ZwnJaL_sdKab_R_OsCTLT_LFh1_L5fUcA_2i9FIe-k69/pub?w=1223&h=691" alt></p><p>cOS provides a runtime and buildtime framework for containers in order to boot them in VMs, Baremetals and Cloud.</p><p>You can either choose to <strong>build</strong> a cOS derivative or <strong>run</strong> cOS to boostrap a new system.</p><p>cOS vanilla images are published to allow further customization when building derivatives. Derivatives can be built just with Container images, and cOS is designed to run, deploy and upgrade those. cOS assets can be used to either drive unattended deployments of a derivative or used to create custom images (with packer).</p><h2 id=build-cos-derivatives>Build cOS derivatives</h2><p>The starting point to use cos-toolkit is to check out our <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/examples>examples</a>, see also <a href=../creating-derivatives/creating_bootable_images>creating bootable images</a> or have a look on one of our <a href=https://github.com/rancher-sandbox/cos-toolkit-sample-repo>sample repository</a>.</p><p>The only requirement to build derivatives with <code>cos-toolkit</code> is docker installed, see <a href=../development>Development notes</a> for more details on how to build <code>cOS</code> itself instead.</p><h3 id=what-to-do-next>What to do next?</h3><p>Check out <a href=../creating-derivatives/creating_bootable_images>how to create bootable images</a> and <a href=../examples/creating_derivatives>how to create full blown derivatives</a> or <a href=../getting-started/download>download the cOS vanilla images</a> to give cOS a try!</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6d9b743260710738d7e98b374307931e>1.1 - Download</h1><div class=lead>How to get cOS vanilla assets: ISOs, Cloud Images, Vagrant boxes, &mldr;.</div><p>cOS-toolkit releases consist on container images that can be used to build derived against and the cos source tree itself.</p><p>cOS supports different release channels, all the final and cache images used are tagged and pushed regularly <a href=https://quay.io/repository/costoolkit/releases-green>to Quay Container Registry</a> and can be pulled for inspection from the registry as well.</p><p>Those are exactly the same images used during upgrades, and can also be used to build Linux derivatives from cOS.</p><p>For example, if you want to see locally what&rsquo;s in a openSUSE cOS version, you can:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ docker run -ti --rm quay.io/costoolkit/releases-green:cos-system-<span style=color:#000>$VERSION</span> /bin/bash
</code></pre></div><h2 id=download-cos>Download cOS</h2><p>You can also try out cOS from the vanilla images and use it to experiment locally or either bootstrap a derivative: those are minimal system with a small package set in order to boot and deploy a container.</p><p>Latest cOS-toolkit releases assets (ISOs, Raw disks, Cloud images) can be found on <a href=https://github.com/rancher-sandbox/cOS-toolkit/releases/>Github</a>, check <a href=../getting-started/booting>Booting</a> for an explanation of each asset type and how to use it.</p><p>cOS can run in: VMs, baremetals and Cloud - the default login username/password is <code>root/cos</code>.</p><h3 id=install>Install</h3><p>To install run <code>cos-installer &lt;device></code> to start the installation process. Remove the ISO/medium and reboot.</p><p><em>Note</em>: <code>cos-installer</code> supports other options as well. Run <code>cos-installer --help</code> to see a complete help.</p><h2 id=releases>Releases</h2><p>cOS has 3 variants:</p><ul><li><a href=https://quay.io/repository/costoolkit/releases-green>green</a>: openSUSE based one, shipping packages from OpenSUSE Leap 15.3 repositories.</li><li><a href=https://quay.io/repository/costoolkit/releases-blue>blue</a>: Fedora based one, shipping packages from Fedora 33 repositories</li><li><a href=https://quay.io/repository/costoolkit/releases-orange>orange</a>: Ubuntu based one, shipping packages form Ubuntu 20.10 repositories</li></ul><p>We currently support and test only the <strong>green</strong> variant.</p><h2 id=published-ami-images>Published AMI images</h2><p>We publish AMI images for each release, you can find them into ec2 for example with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>aws ec2 describe-images --filters <span style=color:#4e9a06>&#39;Name=description,Values=cOS*&#39;</span>
</code></pre></div><h2 id=what-to-do-next>What to do next?</h2><p>Check out <a href=../../customizing>the customization section</a> to customize <code>cOS</code> or <a href=../tutorials>the tutorial section</a> for some already prepared recipe examples.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-20ed69725da67a67450fffe152e9dc9f>1.2 - Booting</h1><div class=lead>Documents various methods for booting cOS vanilla images</div><p>Each cOS release contains a variety of assets:</p><ul><li>ISOs <code>cOS-green-$VERSION.iso.tar.xz</code></li><li>QCOW <code>cOS_green_$VERSION.tar.gz.tar.xz</code></li><li>Vagrant box <code>cOS_green_$VERSION.box.tar.xz</code></li><li>RAW Disk <code>cOS-Vanilla-RAW-$VERSION.raw.tar.xz</code></li><li>VHDA <code>cOS-Vanilla-AZURE-$VERSION.vhd.tar.xz</code></li><li>GCE <code>cOS-Vanilla-GCE-green-$VERSION.raw.tar.xz</code></li></ul><p>here we try to summarize and document how they are meant to be consumed.</p><h2 id=iso>ISO</h2><p>ISO images (e.g. <code>cOS-green-$VERSION.iso.tar.xz</code> ) are shipping a cOS vanilla image and they features an installer to perform an automated installation. They can be used to burn USB sticks or CD/DVD used to boot baremetals. Once booted, you can install cOS with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cos-install <span style=color:#000>$DEVICE</span>
</code></pre></div><p>and after first boot you can switch to a derivative by:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cos-upgrade --docker-image --no-verify <span style=color:#000>$IMAGE</span>
</code></pre></div><h3 id=unattended-deployment>Unattended deployment</h3><p>After booting the iso, it is possible to deploy directly an image of choice with <code>cos-deploy</code></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cos-deploy --docker-image <span style=color:#000>$IMAGE</span>
</code></pre></div><h2 id=virtual-machines>Virtual machines</h2><p>For booting into Virtual machines we offer QCOW2, OVA, and raw disk recovery images which can be used to bootstrap your booting container.</p><h3 id=qcow2>QCOW2</h3><p>QCOW2 images ( e.g. <code>cOS_green_$VERSION.tar.gz.tar.xz</code> ) contains a pre-installed cOS system which can be booted via QEMU, e.g:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qemu-system-x86_64 -m <span style=color:#0000cf;font-weight:700>2048</span> -hda cOS -nographic
</code></pre></div><h3 id=vagrant>Vagrant</h3><p>Download the vagrant box artifact ( e.g. <code>cOS_green_$VERSION.box.tar.xz</code> ), extract it and run:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>vagrant box add cos &lt;cos-box-image&gt;
vagrant init cos
vagrant up
</code></pre></div><h3 id=raw-disk-images>RAW disk images</h3><p>RAW disk images ( e.g. <code>cOS-Vanilla-RAW-green-$VERSION.raw.tar.xz</code> ) contains only the <code>cOS</code> recovery system. Those are typically used when creating derivatives images based on top of <code>cOS</code>.</p><p>They can be run with QEMU with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qemu-system-x86_64 -m <span style=color:#0000cf;font-weight:700>2048</span> -hda &lt;cos-disk-image&gt;.raw -bios /usr/share/qemu/ovmf-x86_64.bin
</code></pre></div><h2 id=cloud-images>Cloud Images</h2><p>Cloud images are <code>vanilla</code> images that boots into <a href=../recovery>recovery mode</a> and can be used to deploy
whatever image you want to the VM. Then you can snapshot that VM into a VM image ready to deploy with the default cOS
system or your derivative.</p><p>At the moment we support Azure and AWS images among our artifacts. We publish AWS images that can also be re-used in packer templates for creating customized AMI images.</p><p>The RAW image can then be used into packer templates to generate custom Images, or used as-is with a userdata to deploy a container image of choice with an input user-data.</p><h3 id=import-an-aws-image-manually>Import an AWS image manually</h3><div class="pageinfo pageinfo-primary"><p>You can also use RAW images ( e.g. <code>cOS-Vanilla-RAW-green-$VERSION.raw.tar.xz</code> ) manually when importing AMIs images and use them to generate images with Packer. See <a href=../../creating-derivatives/packer/build_ami>build AMI with Packer</a></p></div><ol><li>Upload the raw image to an S3 bucket</li></ol><pre><code>aws s3 cp &lt;cos-raw-image&gt; s3://&lt;your_s3_bucket&gt;
</code></pre><ol start=2><li>Created the disk container JSON (<code>container.json</code> file) as:</li></ol><pre><code>{
  &quot;Description&quot;: &quot;cOS Testing image in RAW format&quot;,
  &quot;Format&quot;: &quot;raw&quot;,
  &quot;UserBucket&quot;: {
    &quot;S3Bucket&quot;: &quot;&lt;your_s3_bucket&gt;&quot;,
    &quot;S3Key&quot;: &quot;&lt;cos-raw-image&gt;&quot;
  }
}
</code></pre><ol start=3><li>Import the disk as snapshot</li></ol><pre><code>aws ec2 import-snapshot --description &quot;cOS PoC&quot; --disk-container file://container.json
</code></pre><ol start=4><li><p>Followed the procedure described in <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/creating-an-ami-ebs.html#creating-launching-ami-from-snapshot>AWS docs</a> to register an AMI from snapshot. Used all default settings unless for the firmware, set to force to UEFI boot.</p></li><li><p>Launch instance with this simple userdata with at least a 16Gb boot disk:</p></li></ol><pre><code>name: &quot;Default deployment&quot;
stages:
   rootfs.after:
     - name: &quot;Repart image&quot;
       layout:
         # It will partition a device including the given filesystem label or part label (filesystem label matches first)
         device:
           label: COS_RECOVERY
         add_partitions:
           - fsLabel: COS_STATE
             # 10Gb for COS_STATE, so the disk should have at least 16Gb
             size: 10240
             pLabel: state
           - fsLabel: COS_PERSISTENT
             # unset size or 0 size means all available space
             pLabel: persistent
   initramfs:
     - if: '[ -f &quot;/run/cos/recovery_mode&quot; ]'
       name: &quot;Set sshd to wait for deployment&quot;
       files:
       - path: &quot;/etc/systemd/system/sshd.service.d/override.conf&quot;
         content: |
             [Unit]
             After=cos-setup-network.service
   network:
     - if: '[ -f &quot;/run/cos/recovery_mode&quot; ]'
       name: &quot;Deploy cos-system&quot;
       commands:
         - |
             # Use `cos-deploy --docker-image &lt;img-ref&gt;` to deploy a custom image
             # By default latest cOS gets deployed
             cos-deploy &amp;&amp; shutdown -r now

</code></pre><h3 id=importing-a-google-cloud-image-manually>Importing a Google Cloud image manually</h3><div class="pageinfo pageinfo-primary"><p>You need to use the GCE images ( e.g. <code>cOS-Vanilla-GCE-green-$VERSION.raw.tar.xz</code> ) manually when importing GCE images and use them to generate images with Packer. See <a href=../../creating-derivatives/packer/build_gcp>build GCE with Packer</a></p></div><ol><li>Upload the Google Cloud compressed disk to your bucket</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gsutil cp &lt;cos-gce-image&gt; gs://&lt;your_bucket&gt;/
</code></pre></div><ol start=2><li>Import the disk as an image</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gcloud compute images create &lt;new_image_name&gt; --source-uri<span style=color:#ce5c00;font-weight:700>=</span>&lt;your_bucket&gt;/&lt;cos-gce-image&gt; --guest-os-features<span style=color:#ce5c00;font-weight:700>=</span>UEFI_COMPATIBLE
</code></pre></div><ol start=3><li>Launch instance with this simple userdata with at least a 16Gb boot disk:</li></ol><p style=font-style:italic><i class="fa fa-info-circle" aria-hidden=true>&nbsp;</i>See <a href=https://cloud.google.com/container-optimized-os/docs/how-to/create-configure-instance#using_cloud-init_with_the_cloud_config_format>here</a> on how to add user-data to an instance</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Default deployment&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>rootfs.after</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Repart image&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>layout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># It will partition a device including the given filesystem label or part label (filesystem label matches first)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>device</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_RECOVERY</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>add_partitions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_STATE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># 10Gb for COS_STATE, so the disk should have at least 16Gb</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10240</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>state</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_PERSISTENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># unset size or 0 size means all available space</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>persistent</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Set sshd to wait for deployment&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/etc/systemd/system/sshd.service.d/override.conf&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>             [Unit]
</span><span style=color:#8f5902;font-style:italic>             After=cos-setup-network.service</span><span style=color:#f8f8f8;text-decoration:underline>             
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>network</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Deploy cos-system&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>             # Use `cos-deploy --docker-image &lt;img-ref&gt;` to deploy a custom image
</span><span style=color:#8f5902;font-style:italic>             # By default latest cOS gets deployed
</span><span style=color:#8f5902;font-style:italic>             cos-deploy &amp;&amp; shutdown -r now</span><span style=color:#f8f8f8;text-decoration:underline>             
</span></code></pre></div><h3 id=importing-an-azure-image-manually>Importing an Azure image manually</h3><p style=font-style:italic><i class="fa fa-info-circle" aria-hidden=true>&nbsp;</i><p>You need to use the AZURE images ( e.g. <code>cOS-Vanilla-AZURE-green-$VERSION.raw.tar.xz</code> ) manually when importing Azure images.</p></p><ol><li>Upload the Azure Cloud VHD disk in <code>.vhda</code> format ( extract e.g. <code>cOS-Vanilla-AZURE-green-0.6.0-g7d04f1db.vhd.tar.xz</code> ) to your bucket</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az storage copy --source &lt;cos-azure-image&gt; --destination https://&lt;account&gt;.blob.core.windows.net/&lt;container&gt;/&lt;destination-cos-azure-image&gt;

</code></pre></div><ol start=2><li>Import the disk as an image</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az image create --resource-group &lt;resource-group&gt; --source https://&lt;account&gt;.blob.core.windows.net/&lt;container&gt;/&lt;cos-azure-image&gt; --os-type linux --hyper-v-generation v2 --name &lt;image-name&gt;
</code></pre></div><ol start=3><li>Launch instance with this simple userdata with at least a 16Gb boot disk:</li></ol><p>Hint: There is currently no way of altering the boot disk of an Azure VM via GUI, use the azure-cli to launch the VM with an expanded OS disk</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Default deployment&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>rootfs.after</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Repart image&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>layout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># It will partition a device including the given filesystem label or part label (filesystem label matches first)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>device</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_RECOVERY</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>add_partitions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_STATE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># 10Gb for COS_STATE, so the disk should have at least 16Gb</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10240</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>state</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_PERSISTENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># unset size or 0 size means all available space</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>persistent</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Set sshd to wait for deployment&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/etc/systemd/system/sshd.service.d/override.conf&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>             [Unit]
</span><span style=color:#8f5902;font-style:italic>             After=cos-setup-network.service</span><span style=color:#f8f8f8;text-decoration:underline>             
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>network</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Deploy cos-system&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>             # Use `cos-deploy --docker-image &lt;img-ref&gt;` to deploy a custom image
</span><span style=color:#8f5902;font-style:italic>             # By default latest cOS gets deployed
</span><span style=color:#8f5902;font-style:italic>             cos-deploy &amp;&amp; shutdown -r now</span><span style=color:#f8f8f8;text-decoration:underline>             
</span></code></pre></div><h2 id=login>Login</h2><p>By default you can login with the user <code>root</code> and password <code>cos</code>.</p><p>See the <a href=../../customizing/login>customization section</a> for examples on how to persist username and password changes after installation.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b8ae70d603defa5e6fa86ed3ac457356>1.3 - Upgrading</h1><div class=lead>How to run upgrades in cOS</div><p>To upgrade an installed system, just run <code>cos-upgrade</code> and reboot.</p><h2 id=how-it-works>How it works</h2><p>cOS during installation sets two <code>.img</code> images files in the <code>COS_STATE</code> partition:</p><ul><li><code>/cOS/active.img</code> labeled <code>COS_ACTIVE</code>: Where <code>cOS</code> typically boots from</li><li><code>/cOS/passive.img</code> labeled <code>COS_PASSIVE</code>: Where <code>cOS</code> boots for fallback</li></ul><p>Those are used by the upgrade mechanism to prepare and install a pristine <code>cOS</code> each time an upgrade is attempted.</p><h2 id=upgrade-to-a-specific-container-image>Upgrade to a specific container image</h2><p>To specify a single container image to upgrade to instead of the regular upgrade channels, run <code>cos-upgrade --docker-image image</code>.</p><p><em>Note</em> by default <code>cos-upgrade --docker-image</code> checks images against the notary registry server for valid signatures for the images tag. To disable image verification, run <code>cos-upgrade --no-verify --docker-image</code>.</p><p>See the <a href=https://github.com/rancher-sandbox/cos-toolkit-sample-repo#system-upgrades>sample repository</a> readme on how to tweak the upgrade channels for the derivative and <a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample#images>a further description is available here</a></p><h2 id=from-iso>From ISO</h2><p>The ISO can be also used as a recovery medium: type <code>cos-upgrade</code> from a LiveCD. It will then try to upgrade the image of the active partition installed in the system.</p><h2 id=integration-with-system-upgrade-controller>Integration with System Upgrade Controller</h2><p>If running a kubernetes cluster on the <code>cOS</code> system, you can leverage the <a href=https://github.com/rancher/system-upgrade-controller>system-upgrade-controller</a> to trigger upgrades to specific image versions, for example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>upgrade.cattle.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Plan</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cos-upgrade</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>system-upgrade</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>k3s-upgrade</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>concurrency</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>fleet-sample</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># Image tag</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>nodeSelector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchExpressions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- {<span style=color:#204a87;font-weight:700>key: k3s.io/hostname, operator</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Exists}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>serviceAccountName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>system-upgrade</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cordon</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#  drain:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#    force: true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>upgrade</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>quay.io/costoolkit/test-images</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># Image upgrade reference</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>command</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;/usr/sbin/suc-upgrade&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>See also <a href=../tutorials/trigger_upgrades_with_fleet>trigger upgrades with fleet</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-116792d44b4b0a19cbac9a2d12b83ee4>1.4 - Recovery</h1><div class=lead>How to use the recovery partition to reset the system or perform upgrades.</div><p>cOS derivatives have a recovery mechanism built-in which can be leveraged to restore the system to a known point. At installation time, the recovery partition is created from the installation medium.</p><h3 id=recovery-partition>Recovery partition</h3><p>A derivative can be recovered anytime by booting into the <code>recovery</code> partition and by running <code>cos-reset</code> from it.</p><p>This command will regenerate the bootloader and the images in the <code>COS_STATE</code> partition by using the recovery image.</p><h3 id=upgrading-the-recovery-partition>Upgrading the recovery partition</h3><p>The recovery partition can also be upgraded by running</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cos-upgrade --recovery
</code></pre></div><p>from either the active or passive partition.</p><p>It also supports to specify docker images directly:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cos-upgrade --recovery --docker-image &lt;image&gt;
</code></pre></div><p><em>Note</em>: the command has to be run in the standard partitions used for boot (Active or Fallback).</p><h3 id=upgrading-from-the-recovery-partition>Upgrading from the recovery partition</h3><p>The recovery partition can upgrade also the active system by running <code>cos-upgrade</code>, and it also supports to specify docker images directly:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cos-upgrade --recovery --docker-image &lt;image&gt;
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-4f8fa1d779276bb728601b46845a8df5>2 - Customizing</h1><div class=lead>This section contains various articles relative on how to customize cOS, branding and behavior.</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vR-I5ZwwB5EjpsymUfcNADRTTKXrNMnlZHgD8RjDpzYhyYiz_JrWJwvpcfMcwfYet1oWCZVWH22aj1k/pub?w=533&h=443" alt="Partitioning layout"></p><p>By default, <code>cos</code> and derivatives will inherit an immutable setup.
A running system will look like as follows:</p><pre><code>/usr/local - persistent (COS_PERSISTENT)
/oem - persistent (COS_OEM)
/etc - ephemeral
/usr - read only
/ immutable
</code></pre><p>This means that any changes that are not specified as cloud-init configuration are not persisting across reboots.</p><p>You can place persisting cloud-init files either in <code>/oem</code> or <code>/usr/local/oem</code>, <code>cOS</code> already supports cloud-init <a href=https://cloudinit.readthedocs.io/en/latest/topics/datasources.html>datasources</a>, so you can use also load cloud-init configuration as standard userdata, depending on the platform. For more details on the cloud-init syntax, see the <a href=../reference/cloud_init>cloud-init configuration reference</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-8637cd7f2ce65f4c97959f4d2a723eb9>2.1 - Stages</h1><div class=lead>Configure the system in the various stages: boot, initramfs, fs, network, reconcile</div><p>Cloud-init files in <code>/system/oem</code>, <code>/oem</code> and <code>/usr/local/oem</code> are applied in 5 different phases: <code>boot</code>, <code>network</code>, <code>fs</code>, <code>initramfs</code> and <code>reconcile</code>. All the available cloud-init keywords can be used in each stage. Additionally, it&rsquo;s possible also to hook before or after a stage has run, each one has a specific stage which is possible to run steps: <code>boot.after</code>, <code>network.before</code>, <code>fs.after</code> etc.</p><p>Multiple stages can be specified in a single cloud-init file.</p><h4 id=rootfs>rootfs</h4><p>This is the earliest stage, running before switching root, just right after the
root is mounted in <code>/sysroot</code> and before applying the immutable rootfs configuration.
This stage is executed over initrd root, no chroot is applied.</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Set persistent devices&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Layout configuration&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>environment_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/run/cos/cos-layout.env</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>VOLUMES</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;LABEL=COS_OEM:/oem LABEL=COS_PERSISTENT:/usr/local&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>OVERLAY</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;tmpfs:25%&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h4 id=initramfs>initramfs</h4><p>This is still an early stage, running before switching root. Here you can apply radical changes to the booting setup of <code>cOS</code>.
Despite this is executed before switching root this exection runs chrooted into the target root after the immutable rootfs is set up and ready.</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something on initramfs&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          # Run something when we are booting in active or passive
</span><span style=color:#8f5902;font-style:italic>          touch /etc/something_important</span><span style=color:#f8f8f8;text-decoration:underline>          
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in recovery mode</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h4 id=boot>boot</h4><p>This stage is executed after initramfs has switched root, during the <code>systemd</code> bootup process.</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something on boot&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>boot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in active or passive</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in recovery mode</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h4 id=fs>fs</h4><p>This stage is executed when fs is mounted and is guaranteed to have access to <code>COS_STATE</code> and <code>COS_PERSISTENT</code>.</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something on boot&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>fs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#000>touch /usr/local/something</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in recovery mode</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h4 id=network>network</h4><p>This stage is executed when network is available</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something on boot&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>network</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Network is available, do something..</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h4 id=reconcile>reconcile</h4><p>This stage is executed <code>5m</code> after boot and periodically each <code>60m</code>.</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something on boot&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>reconcile</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/sentinel&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#000>touch /run/sentinel</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-80272a2426a531df16f16d019ccd6724>2.2 - Persistency</h1><div class=lead>Persisting configurations in cOS and derivatives</div><p>It is possible to install a custom <a href=../../reference/cloud_init/>cloud-init style file</a> during install with <code>--config</code> to <code>cos-installer</code> or, it&rsquo;s possible to add more files manually to the <code>/oem</code> folder after installation. The file will be placed under <code>/usr/local/oem</code> and will persist across reboots.</p><p>By default cOS and derivatives, are reading and executing cloud-init files in (lexicopgrahic) sequence present in <code>/system/oem</code>, <code>/usr/local/cloud-config</code> and <code>/oem</code> during boot. It is also possible to run cloud-init file in a different location from boot cmdline by using the <code>cos.setup=..</code> option.</p><p>While <code>/system/oem</code> is reserved for system configurations, for example to be included in the container image, the <code>/oem</code> folder instead is reserved for persistent cloud-init files to be executed in the various stages.</p><p>For example, if you want to change <code>/etc/issue</code> of the system persistently, you can create <code>/usr/local/cloud-config/90_after_install.yaml</code> with the following content:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># The following is executed before fs is setted up:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;After install&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/issue</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                    </span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#000>Welcome, have fun!</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0644</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>systemctl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>disable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#000>wicked</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;After install (second step)&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/motd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                    </span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#000>Welcome, have more fun!</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0644</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>For more examples you can find <code>/system/oem</code> inside cOS vanilla images containing files used to configure on boot a pristine <code>cOS</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4c6f31346340371adbb7fd2ceccc2e88>2.3 - Login</h1><div class=lead>Default login, and how to override it</div><p>By default you can login with the user <code>root</code> and <code>cos</code>.</p><p>You can change this by overriding <code>/system/oem/04_accounting.yaml</code> in the container image, or in the running system in the persistency folder.</p><h3 id=examples>Examples</h3><ul><li><a href=https://github.com/rancher-sandbox/cos-toolkit-sample-repo/blob/00c0b4abf8225224c1c177f5b3bd818c7b091eaf/packages/sampleOS/build.yaml#L13>Changing root password</a></li><li><a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample/blob/master/packages/epinioOS/04_accounting.yaml>Example accounting file</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-72eef8ed52ca1d1dab6e21a58816bac9>2.4 - OEM configuration</h1><div class=lead>OEM configuration reserved to cOS and derivatives</div><p>There are several way to customize cOS and a cos-toolkit derivative:</p><ul><li>declaratively in runtime with cloud-config file (by overriding, or extending)</li><li>stateful, embedding any configuration in the container image to be booted.</li></ul><p>For runtime persistence configuration, the only supported way is with cloud-config files, <a href=../configuration_persistency>see the relevant docs</a>.</p><p>A derivative automatically loads and executes cloud-config files during the various system <a href=../stages>stages</a> also inside <code>/system/oem</code> which is read-only and reserved to the system.</p><div class="pageinfo pageinfo-primary"><p>The cloud-config mechanism works also as an emitter event pattern - running services or programs can emit new custom <code>stages</code> in runtime by running <code>cos-setup stage_name</code>.</p></div><p>Derivatives that wish to override default configurations can do that by placing extra cloud-init file, or overriding completely <code>/system/oem</code> in the target image.</p><p>This is to setup for example, the default root password or the prefered upgrade channel.</p><p>The following are the <code>cOS</code> default oem files:</p><pre><code>/system/oem/00_rootfs.yaml - defines the rootfs mountpoint layout setting
/system/oem/01_defaults.yaml - systemd defaults (keyboard layout, timezone)
/system/oem/02_upgrades.yaml - Settings for channel upgrades
/system/oem/03_branding.yaml - Branding setting, Derivative name, /etc/issue content
/system/oem/04_accounting.yaml - Default user/pass
/system/oem/05_network.yaml - Default network setup
/system/oem/06_recovery.yaml - Executes additional commands when booting in recovery mode
</code></pre><p>If you are building a cOS derivative, and plan to release upgrades, you must override (or create a new file under <code>/system/oem</code>) the <code>/system/oem/02_upgrades.yaml</code> pointing to the docker registry used to deliver upgrades.</p><p><a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample#images>See also the example appliance</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-891dfa0a6f57b2aababf7ee877e38876>2.5 - Upgrades</h1><div class=lead>Customizing the default upgrade channel</div><p><code>cOS</code> vanilla images by default are picking upgrades by the standard upgrade channel. It means it will always get the latest published <code>cOS</code> version by our CI.</p><p>However, it&rsquo;s possible to tweak the default behavior of <code>cos-upgrade</code> to point to a specific docker image/tag, or a different release channel.</p><p>By default, <code>cos</code> derivatives if not specified will point to latest <code>cos-toolkit</code>. To override, you need to or overwrite the content of <code>/system/oem/02_upgrades.yaml</code> or supply an additional one, e.g. <code>/system/oem/03_upgrades.yaml</code> in the final image, see <a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample/blob/master/packages/epinioOS/02_upgrades.yaml>an example here</a>.</p><h2 id=etccos-upgrade-image><code>/etc/cos-upgrade-image</code></h2><p>This file is read from <code>cos-upgrade</code> during start and allows to tweak the following:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># Tweak the package to upgrade to, or the docker image (full reference)</span>
<span style=color:#000>UPGRADE_IMAGE</span><span style=color:#ce5c00;font-weight:700>=</span>system/cos
<span style=color:#8f5902;font-style:italic># Turn on/off channel upgrades. If disabled, UPGRADE_IMAGE should be a full reference to a container image</span>
<span style=color:#000>CHANNEL_UPGRADES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
<span style=color:#8f5902;font-style:italic># Turn on/off image signature checking. This is enabled by default when receiving upgrades from official channel</span>
<span style=color:#000>VERIFY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
<span style=color:#8f5902;font-style:italic># Specify a separate recovery image (defaults to UPGRADE_IMAGE)</span>
<span style=color:#000>RECOVERY_IMAGE</span><span style=color:#ce5c00;font-weight:700>=</span>recovery/cos
</code></pre></div><ul><li><strong>UPGRADE_IMAGE</strong>: A container image reference ( e.g. <code>registry.io/org/image:tag</code> ) or a <code>luet</code> package ( e.g. <code>system/cos</code> )</li><li><strong>CHANNEL_UPGRADES</strong>: Boolean indicating wether to use channel upgrades or not. If it is disabled <strong>UPGRADE_IMAGE</strong> should refer to a container image, e.g. <code>registry.io/org/image:tag</code></li><li><strong>VERIFY</strong>: Turns on and off image verification. Currently available for official <code>cOS</code> release channels</li><li><strong>RECOVERY_IMAGE</strong>: Allows to specify a different image for the recovery partition. Similarly to <strong>UPGRADE_IMAGE</strong> needs to be either an image reference or a package.</li></ul><p>An example on how to tweak this file via cloud-init is available <a href=https://github.com/rancher-sandbox/cos-toolkit-sample-repo/blob/7355876847367b75485873987e1217f1e1fe6254/packages/sampleOS/02_upgrades.yaml#L41>here</a></p><h2 id=changing-the-default-release-channel>Changing the default release channel</h2><p>Release channels are standard luet repositories. To change the default release channel, create a <code>/etc/luet/luet.yaml</code> configuration file pointing to a valid luet repository:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># For a full reference, see:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># https://luet-lab.github.io/docs/docs/getting-started/#configuration</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>logging</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>color</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable_emoji</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>general</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>debug</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spinner_charset</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;sampleos&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;sampleOS&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;docker&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cached</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>priority</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>verify</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>urls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;quay.io/costoolkit/releases-green&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>An example on how to tweak this file via cloud-init is available <a href=https://github.com/rancher-sandbox/cos-toolkit-sample-repo/blob/7355876847367b75485873987e1217f1e1fe6254/packages/sampleOS/02_upgrades.yaml#L11>here</a></p><h2 id=references>References</h2><ul><li><a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample#images>complete example and documentation</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-da6b91d86be15305a06525d5ddec51fc>2.6 - GRUB</h1><div class=lead>GRUB 2 Configuration</div><p>COS is set to deploy a persistent <code>grub.cfg</code> into the <code>COS_RECOVERY</code> partition during
the system installation or image creation. COS grub configuration
includes three menu entries: first for the main OS system, second for the
fallback OS system and a third for the recovery OS.</p><p>For example the main OS system menu entry could be something like:</p><pre><code>menuentry &quot;cOS&quot; --id cos {
  search.fs_label COS_STATE root
  set img=/cOS/active.img
  set label=COS_ACTIVE
  loopback loop0 /$img
  set root=($root)
  source (loop0)/etc/cos/bootargs.cfg
  linux (loop0)$kernel $kernelcmd
  initrd (loop0)$initramfs
}
</code></pre><p>Someting relevant to note is that the kernel parameters are not part of the
persistent <code>grub.cfg</code> file stored in <code>COS_RECOVERY</code> partition. Kernel parameters
are sourced from the loop device of the OS image to boot. This is mainly to
keep kernel parameters consistent across different potential OS images or
system upgrades.</p><p>In fact, cOS images and its derivatives, are expected to include a
<code>/etc/cos/bootargs.cfg</code> file which provides the definition of the following
variables:</p><ul><li><code>$kernel</code>: Path of the kernel binary</li><li><code>$kernelcmd</code>: Kernel parameters</li><li><code>$initramfs</code>: Path of the initrd binary</li></ul><p>This is the mechanism any cOS image or cOS derivative has to communicate
its boot parameters (kernel, kernel params and initrd file) to GRUB2.</p><p>For example a cOS bootarg.cfg file could be:</p><pre><code>set kernel=/boot/vmlinuz
if [ -n &quot;$recoverylabel&quot; ]; then
    # Boot arguments when the image is used as recovery
    set kernelcmd=&quot;console=tty1 root=live:CDLABEL=$recoverylabel rd.live.dir=/ rd.live.squashimg=$img panic=5&quot;
else
    # Boot arguments when the image is used as active/passive
    set kernelcmd=&quot;console=tty1 root=LABEL=$label iso-scan/filename=$img panic=5 security=selinux selinux=1&quot;
fi

set initramfs=/boot/initrd
</code></pre><p>You can tweak that file to suit your needs if you need to specify persistent boot arguments.</p><h2 id=grub-environment-variables>Grub environment variables</h2><p>cOS (since v0.5.8) makes use of the GRUB2 environment block which can used to define
persistent GRUB2 variables across reboots.</p><p>The default grub configuration loads the <code>/grubenv</code> of any available device
and evaluates on <code>next_entry</code> variable and <code>saved_entry</code> variable. By default
none is set.</p><p>The default boot entry is set to the value of <code>saved_entry</code>, in case the variable
is not set grub just defaults to the first menu entry.</p><p><code>next_entry</code> variable can be used to overwrite the default boot entry for a single
boot. If <code>next_entry</code> variable is set this is only being used once, GRUB2 will
unset it after reading it for the first time. This is helpful to define the menu entry
to reboot to without having to make any permanent config change.</p><p>Use <code>grub2-editenv</code> command line utility to define desired values.</p><p>For instance use the following command to reboot to recovery system only once:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; grub2-editenv /oem/grubenv <span style=color:#204a87>set</span> <span style=color:#000>next_entry</span><span style=color:#ce5c00;font-weight:700>=</span>recovery
</code></pre></div><p>Or to set the default entry to <code>fallback</code> system:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; grub2-editenv /oem/grubenv <span style=color:#204a87>set</span> <span style=color:#000>default</span><span style=color:#ce5c00;font-weight:700>=</span>fallback
</code></pre></div><p>These examples make of the <code>COS_OEM</code> device, however it could use any device
detected by GRUB2 that includes the file <code>/grubenv</code>. First match wins.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5a2f2ae34ebe6581185222d4c362a1d2>3 - Creating derivatives</h1><div class=lead>Documents various methods for creating cOS derivatives</div><p>All the documentation below imply that the container image generated will be the booting one, there are however several configuration entrypoint that you should keep in mind while building the image which are general across all the implementation:</p><ul><li>Custom persistent runtime configuration has to be provided in <code>/system/oem</code> for derivatives, <a href=../customizing/configuration_persistency>see also the documentation section</a>. Everything under <code>/system/oem</code> will be loaded during the various stages (boot, network, initramfs). You can check <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/e411d8b3f0044edffc6fafa39f3097b471ef46bc/packages/cloud-config/oem>here</a> for the <code>cOS</code> defaults. See <code>00_rootfs.yaml</code> to customize the booting layout.</li><li><code>/etc/cos/bootargs.cfg</code> contains the booting options required to boot the image with GRUB, <a href=../customizing/configure_grub>see grub customization</a></li><li><code>/etc/cos-upgrade-image</code> contains the default upgrade configuration for recovery and the booting system image, <a href=../customizing/upgrades>see customizing upgrades</a></li></ul><p>Derivatives inherits <code>cOS</code> defaults, which you can override during the build process, however there are some defaults which are relevant and listed below:</p></div><div class=td-content style=page-break-before:always><h1 id=pg-392e7921a89bd32cc9ec22ec800e2673>3.1 - Package stack</h1><div class=lead>Package stack for derivatives</div><p>When building a <code>cos-toolkit</code> derivative, a common set of packages are provided already with a common default configuration. Some of the most notably are:</p><ul><li>systemd as init system</li><li>grub for boot loader</li><li>dracut for initramfs</li></ul><p>Each <code>cos-toolkit</code> flavor (opensuse, ubuntu, fedora) ships their own set of base packages depending on the distribution they are based against. You can find the list of packages in the <code>packages</code> keyword in the corresponding <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/values>values file for each flavor</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c76daa64bd1164d9a6d538211f0fa16b>3.2 - Creating bootable images</h1><div class=lead>This document describes the requirements to create standard container images that can be used for <code>cOS</code> deployments</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vSmIZ5FTInGjtkGonUOgwhti6DZnSoeexGmWL9CAmbdiIGtBGnzDuGNj80Lj_206hP0MOxQGpEdYFvK/pub?w=1223&h=691" alt></p><p>It&rsquo;s possible to create standard container images which are consumable by the vanilla <code>cOS</code> images (ISO, Cloud Images, etc.) during the upgrade and deploy phase.</p><p>This allows anyone to create bootable images by just building and publishing a container image with the usual container workflow, and is a way to persist <a href=../../customizing>customizations</a>. The image have to contain parts of the cos-toolkit in order to be bootable, an illustrative example can be:</p><pre><code>ARG LUET_VERSION=0.16.7

FROM quay.io/luet/base:$LUET_VERSION AS luet

FROM opensuse/leap:15.3
ARG ARCH=amd64
ENV ARCH=${ARCH}
RUN zypper in -y ...

RUN luet install -y \
    toolchain/yip \
    utils/installer \
    system/cos-setup \
    system/immutable-rootfs \
    system/grub-config \
    system/cloud-config \
    utils/k9s \
    utils/nerdctl

# Other custom logic. E.g, customize statically the upgrade channel, default users, packages.
...
</code></pre><p>The workflow would be then:</p><ol><li><code>docker build</code> the image</li><li><code>docker push</code> the image to some registry</li><li><code>cos-upgrade --docker-image --no-verify $IMAGE</code> from a cOS machine ( or <code>cos-deploy</code> if bootstrapping a cloud image )</li></ol><p>You can explore more examples in the <a href=../../examples/creating_bootable_images>example section</a> on how to create bootable images.</p><p><strong>Note</strong> : the image should provide at least <code>grub</code>, <code>systemd</code> and <code>dracut</code>, as are the common set of packages between derivatives. See also <a href=../package_stack>package stack</a></p><h2 id=whats-next>What&rsquo;s next?</h2><p>Now that we have created our derivative container, we can either:</p><ul><li><a href=../build_iso>Build an iso</a></li><li><a href=../packer/build_ami>Build an Amazon Image</a></li><li><a href=../packer/build_gcp>Build a Google Cloud Image</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1c4b24f482e46235525d199eb0414f03>3.3 - Build ISOs</h1><div class=lead>Build ISOs from bootable images</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vReZtyNs0imrji-AwnqK0-4ekCKLcKzfnQ_CwiMj93Q7IsycAJHwlNohwCv_hyHnaify7qO-v2Cecg5/pub?w=1223&h=691" alt></p><p>In order to build an iso at the moment of writing, we first rely on <a href=https://github.com/mudler/luet-makeiso>luet-makeiso</a>. It accepts a YAML file denoting the packages to bundle in an ISO and a list of luet repositories where to download the packages from.</p><p>To build an iso, just run:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run -v <span style=color:#000>$PWD</span>:/cOS -v /var/run:/var/run --entrypoint /usr/bin/luet-makeiso -ti --rm quay.io/costoolkit/toolchain ./iso.yaml --image <span style=color:#000>$IMAGE</span>
</code></pre></div><p>Where <code>iso.yaml</code> is the iso specification file, and <code>--image $IMAGE</code> is the container image you want to build the ISO for, you might want to check on <a href=../creating_bootable_images>how to build bootable images</a>.</p><p>An example of a yaml file using the cos-toolkit opensuse repositories:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>system/sampleOS</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/systemd-boot</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/boot</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/syslinux</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/boot</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kernel_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;vmlinuz&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;initrd&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;sampleOS-0.&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_date</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;COS_LIVE&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>luet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cOS</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>urls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>quay.io/costoolkit/releases-green</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>docker</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><small><i class="fab fa-github"></i> <i>Complete source code: <a target=_blank href=https://github.com/rancher-sandbox/cos-toolkit-sample-repo/blob/master/iso.yaml>https://github.com/rancher-sandbox/cos-toolkit-sample-repo/blob/master/iso.yaml</a></i></small><hr><h2 id=whats-next>What&rsquo;s next?</h2><ul><li>Check out on how to <a href=../packer/build_images>build a QCOW, Virtualbox or Vagrant image</a> from the ISO we have just created</li></ul><h2 id=syntax>Syntax</h2><p>Below you can find a full reference about the yaml file format.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># (optional) Packages to be installed in the rootfs</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># Packages to be installed in the uefi image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/systemd-boot</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/boot</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># Packages to be installed in the isoimage</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/syslinux</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Specify initramfs/kernel and avoid generation on-the-fly</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># files must be present on /boot folder in the rootfs</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kernel_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;vmlinuz&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;initrd&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>overlay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/path/to/additional/files&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/path/to/additional/uefi/files&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/path/to/additional/efi/files&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Specify a container remote image to pull and use for the rootfs in place of packages (optional)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>rootfs_image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;ubuntu:latest&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Image prefix. If Image date is disabled is used as the full title.</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;MYOS-0.&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_date</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Luet repositories (https://luet-lab.github.io/docs/docs/getting-started/#configuration-in-etcluetreposconfd) to use.</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>luet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cOS</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>urls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>quay.io/costoolkit/releases-green</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>docker</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Flags:</p><ul><li><strong>local</strong>: Path to local luet repository to use to install packages from</li><li><strong>image</strong>: Optional image to use as rootfs</li></ul><h2 id=configuration-reference>Configuration reference</h2><h3 id=rootfs_image><code>rootfs_image</code></h3><p>A container image reference (e.g. <code>quay.io/.../...:latest</code>) that will be used as a rootfs for the ISO.</p><h3 id=packagesrootfs><code>packages.rootfs</code></h3><p>A list of luet packages to install in the rootfs. The rootfs will be squashed to a <code>rootfs.squashfs</code> file</p><h3 id=packagesuefi><code>packages.uefi</code></h3><p>A list of luet packages to be present in the efi ISO sector.</p><h3 id=packagesisoimage><code>packages.isoimage</code></h3><p>A list of luet packages to be present in the ISO image.</p><h3 id=repositorypackages><code>repository.packages</code></h3><p>A list of package repository (e.g. <code>repository/mocaccino-extra</code>) to be installed before <code>luet install</code> commands Requirements</p><h3 id=initramfskernel_file><code>initramfs.kernel_file</code></h3><p>The kernel file under <code>/boot/</code> that is your running kernel. e.g. <code>vmlinuz</code> or <code>bzImage</code></p><h3 id=initramfsrootfs_file><code>initramfs.rootfs_file</code></h3><p>The initrd file under <code>/boot/</code> that has all the utils for the initramfs</p><h3 id=image_prefix><code>image_prefix</code></h3><p>ISO image prefix to use</p><h3 id=image_date><code>image_date</code></h3><p>Boolean indicating if the output image name has to contain the date</p><h3 id=image_name><code>image_name</code></h3><p>A string representing the ISO final image name</p><h3 id=arch><code>arch</code></h3><p>A string representing the arch. Defaults to <code>x86_64</code>.</p><h3 id=luetconfig><code>luet.config</code></h3><p>Path to the luet config to use to install the packages from</p><h3 id=overlayisoimage><code>overlay.isoimage</code></h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>overlay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;dir&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Path to a folder which content will be copied over the ISO (before generating the ISO file).</p><h3 id=overlayuefi><code>overlay.uefi</code></h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>overlay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;dir&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Path to a folder which content will be copied over the UEFI partition (before generating the image).</p><h3 id=overlayrootfs><code>overlay.rootfs</code></h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>overlay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;dir&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Path to a folder which content will be copied over the rootfs (before generating squashfs).</p><h2 id=separate-recovery>Separate recovery</h2><p>To make an ISO with a separate recovery image as squashfs, you can either use the default from <code>cOS</code>, by adding it in the iso yaml file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>recovery/cos-img</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>The installer will detect the squashfs file in the iso, and will use it when installing the system. You can customize the recovery image as well by providing your own: see the <code>recovery/cos-img</code> package definition as a reference.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a79e4c2576797b293b9be51f953489dd>3.4 - Building images with Packer</h1><div class=lead>Building VBox, OVA, QEMU, etc. images of your derivative with Packer</div><p>For Vagrant Boxes, OVA and QEMU images at the moment we are relying on <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>packer templates</a>.</p></div><div class=td-content><h1 id=pg-3919e113335b9645a5bc90d158baa902>3.4.1 - Build AMI machines for AWS</h1><div class=lead>This section documents the procedure to deploy cOS (or derivatives) images in AWS public cloud provider by using the cOS Vanilla image.</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vSqJWcFThP7K2HS551LCqs73l4ZncXElLjlbCvxY96Ga2Jbjnq79j-DEjaccUZvYEQyphWiDQc9flxk/pub?w=1223&h=691" alt></p><p>Requirements:</p><ul><li>Packer</li><li>AWS access keys with the appropriate roles and permissions</li><li>A Vanilla AMI</li><li><a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>Packer templates</a></li></ul><p>The suggested approach is based on using Packer templates to customize the
deployment and automate the upload and publish to AWS of cOS derivatives or cOS itself. For all the details
and possibilties of Packer check the <a href=https://www.packer.io/guides/hcl>official documentation</a>.</p><h2 id=run-the-build-with-packer>Run the build with Packer</h2><p>Publishing an AMI image in AWS based on top of the latest cOS Vanilla image is
fairly simple. In fact, it is only needed to set the AWS credentials
and run a <code>packer build</code> process to trigger the deployment and register the
resulting snapshot as an AMI. In such case the lastest cOS image will be
deployed and configured with pure defaults. Consider:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>export</span> <span style=color:#000>AWS_ACCESS_KEY_ID</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_aws_access_key&gt; 
&gt; <span style=color:#204a87>export</span> <span style=color:#000>AWS_SECRET_ACCESS_KEY</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_aws_secret_access_key&gt; 
&gt; <span style=color:#204a87>export</span> <span style=color:#000>AWS_DEFAULT_REGION</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_aws_default_region&gt;

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -only amazon-ebs.cos .
</code></pre></div><p>AWS keys can be passed as environment variables as it is above or packer
picks them from aws-cli configuration files (<code>~/.aws</code>) if any. Alternatively,
one can define them in the variables file.</p><p>The <code>-only amazon-ebs.cos</code> flag is just to tell packer which of the sources
to make use for the build. Note the <code>packer/images.json.pkr.hcl</code> file defines
few other sources such as <code>qemu</code> and <code>virtualbox</code>.</p><h2 id=customize-the-build-with-a-variables-file>Customize the build with a variables file</h2><p>The packer template can be customized with the variables defined in
<code>packer/variables.pkr.hcl</code>. These are the variables that can be set on run
time using the <code>-var key=value</code> or <code>-var-file=path</code> flags. The variable file
can be a json file including desired varibles. Consider the following example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the packer folder of the cOS-toolkit repository checkout</span>

&gt; cat <span style=color:#4e9a06>&lt;&lt; EOF &gt; test.json
</span><span style=color:#4e9a06>{
</span><span style=color:#4e9a06>    &#34;aws_cos_deploy_args&#34;: &#34;cos-deploy&#34;,
</span><span style=color:#4e9a06>    &#34;aws_launch_volume_size&#34;: 16,
</span><span style=color:#4e9a06>    &#34;name&#34;: &#34;MyTest&#34;
</span><span style=color:#4e9a06>}
</span><span style=color:#4e9a06>EOF</span>

&gt; packer build -only amazon-ebs.cos -var-file<span style=color:#ce5c00;font-weight:700>=</span>test.json .
</code></pre></div><p>The above example runs the AMI Vanilla image on a 16GiB disk and calls the
command <code>cos-deploy</code> to deploy the main OS, once deployed an snapshot is
created and an AMI out this snapshot is registered in EC2. The created
AMI artifact will be called <code>MyTest</code>, the name has no impact in the underlaying
OS.</p><h3 id=available-variables-for-customization>Available variables for customization</h3><p>All the customizable variables are listed in <code>packer/variables.pkr.hcl</code>,
variables with the <code>aws_</code> prefix are the ones related to the AWS Packer
template. These are some of the relevant ones:</p><ul><li><p><code>aws_cos_deploy_args</code>: This the command that will be executed once the
Vanilla image booted. In this stage it is expected that user sets a command
to install the desired cOS or derivative image. By default it is set to
<code>cos-deploy</code> which will deploy the latest cOS image in cOS repositories.
To deploy custom derivatives something like
<code>cos-deploy --docker-image &lt;my-derivative-img-ref></code> should be sufficient.</p></li><li><p><code>aws_launch_volume_size</code>: This sets the disk size of the VM that Packer
launches for the build. During Vanilla image first boot the system will
expand to the disk geometry. The layout is configurable with the user-data.</p></li><li><p><code>aws_user_data_file</code>: This sets the user-data file that will be used for the
aws instance during the build process. It defaults to <code>aws/setup-disk.yaml</code> and
the defauklt file basically includes the disk expansion configuration. It
adds a <code>COS_STATE</code> partition that should be big enough to store about three times
the size of the image to deploy. Then it also creates a <code>COS_PERSISTENT</code>
partition with all the rest of the available space in disk.</p></li><li><p><code>aws_source_ami_filter_name</code>: This a filter to choose the AMI image for the
build process. It defaults to <code>*cOS*Vanilla*</code> pattern to pick the latest cOS
Vanilla image available.</p></li><li><p><code>aws_temporary_security_group_source_cidr</code>: A IPv4 CIDR to be authorized access to the instance,
when packer is creating a temporary security group. Defaults to &ldquo;0.0.0.0/0&rdquo;.</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-053d994238218800fd0349937370b515>3.4.2 - Build Images for Google Compute Platform</h1><div class=lead>This section documents the procedure to deploy cOS (or derivatives) images in Google Compute Platform by using the cOS Vanilla image.</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vSqJWcFThP7K2HS551LCqs73l4ZncXElLjlbCvxY96Ga2Jbjnq79j-DEjaccUZvYEQyphWiDQc9flxk/pub?w=1223&h=691" alt></p><p>Requirements:</p><ul><li>Packer</li><li>Google Compute Packer <a href=https://www.packer.io/docs/builders/googlecompute>plugin</a></li><li><a href=https://cloud.google.com/sdk/docs/install>Google Cloud SDK</a></li><li>A Vanilla AMI</li><li><a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>Packer templates</a></li></ul><p>The suggested approach is based on using Packer templates to customize the
deployment and automate the upload and publish to GCP of cOS derivatives or cOS itself. For all the details
and possibilties of Packer check the <a href=https://www.packer.io/guides/hcl>official documentation</a>.</p><p>There are no cOS Vanilla images publicly available in GCP, however they can be easily
build or downloaded and published to your working GCP project. See <a href=../../../development/build_raw_images/>Build Raw Images</a> and
<a href=../../../getting-started/booting/#importing-a-google-cloud-image-manually>Importing a Google Cloud image manually</a> to see how to upload a Vanilla image in your project.</p><h2 id=run-the-build-with-packer>Run the build with Packer</h2><p>Publishing an image in GCP based on top of the latest cOS Vanilla image is
fairly simple. In fact, it is only needed to set the <a href=https://www.packer.io/docs/builders/googlecompute#running-locally-on-your-workstation>User Application Default Credentials</a>
for GCP and the GCP project ID and then run a <code>packer build</code> process to
trigger the deployment and register the resulting snapshot as an image.
In such case the lastest cOS image will be deployed and configured with
pure defaults. Consider:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>export</span> <span style=color:#000>GCP_PROJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_gcp_project_id&gt;

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -only gcp.cos .
</code></pre></div><p>Packer authenticates automatically if the
<a href=https://www.packer.io/docs/builders/googlecompute#running-locally-on-your-workstation>User Application Default Credentials</a>
are properly set in the host.</p><p>The <code>-only gcp.cos</code> flag is just to tell packer which of the sources
to make use for the build. Note the <code>packer/images.json.pkr.hcl</code> file defines
few other sources such as <code>qemu</code>, <code>virtualbox</code> and <code>amazon-ebs</code>.</p><h2 id=customize-the-build-with-a-variables-file>Customize the build with a variables file</h2><p>The packer template can be customized with the variables defined in
<code>packer/variables.pkr.hcl</code>. These are the variables that can be set on run
time using the <code>-var key=value</code> or <code>-var-file=path</code> flags. The variable file
can be a json file including desired varibles. Consider the following example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the packer folder of the cOS-toolkit repository checkout</span>

&gt; cat <span style=color:#4e9a06>&lt;&lt; EOF &gt; test.json
</span><span style=color:#4e9a06>{
</span><span style=color:#4e9a06>    &#34;gcp_project_id&#34;: &#34;&lt;your_gcp_project&gt;&#34;
</span><span style=color:#4e9a06>    &#34;gcp_cos_deploy_args&#34;: &#34;cos-deploy --docker-image &lt;my-custom-image&gt;&#34;,
</span><span style=color:#4e9a06>    &#34;gcp_disk_size&#34;: 20,
</span><span style=color:#4e9a06>    &#34;name&#34;: &#34;MyTest&#34;
</span><span style=color:#4e9a06>}
</span><span style=color:#4e9a06>EOF</span>

&gt; packer build -only gcp.cos -var-file<span style=color:#ce5c00;font-weight:700>=</span>test.json .
</code></pre></div><p>The above example runs the cOS Vanilla image on a 20GB disk and calls the
command <code>cos-deploy</code> to deploy the main OS, once deployed an snapshot is
created and published as an image in Google Compute Engine. The created
artifact will be called <code>MyTest</code>, the name has no impact in the underlaying
OS.</p><h3 id=available-variables-for-customization>Available variables for customization</h3><p>All the customizable variables are listed in <code>packer/variables.pkr.hcl</code>,
variables with the <code>aws_</code> prefix are the ones related to the AWS Packer
template. These are some of the relevant ones:</p><ul><li><p><code>gcp_project_id</code>: The project ID that will be used to launch instances and
store images.</p></li><li><p><code>gcp_cos_deploy_args</code>: This the command that will be executed once the
Vanilla image booted. In this stage it is expected that user sets a command
to install the desired cOS or derivative image. By default it is set to
<code>cos-deploy</code> which will deploy the latest cOS image in cOS repositories.
To deploy custom derivatives something like
<code>cos-deploy --docker-image &lt;my-derivative-img-ref></code> should be sufficient.</p></li><li><p><code>gcp_disk_size</code>: This sets the disk size of the VM that Packer
launches for the build. During Vanilla image first boot the system will
expand to the disk geometry. The layout is configurable with the user-data.</p></li><li><p><code>gcp_user_data_file</code>: This sets the user-data file that will be used for the
aws instance during the build process. It defaults to <code>aws/setup-disk.yaml</code> and
the defauklt file basically includes the disk expansion configuration. It
adds a <code>COS_STATE</code> partition that should be big enough to store about three times
the size of the image to deploy. Then it also creates a <code>COS_PERSISTENT</code>
partition with all the rest of the available space in disk.</p></li><li><p><code>gcp_source_image_family</code>: This the family to choose the image for the
build process. It defaults to <code>cos-vanilla</code> to pick the latest cOS
Vanilla image available. Note Packer tries to find the image family first
in the given working project (<code>gcp_project_id</code>).</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d123bd2dce21a42b3c3ca4afc4f353ad>3.4.3 - Build QCOW, VirtualBox and Vagrant images</h1><div class=lead>This section documents the procedure to build a custom QCOW, VirtualBox and a Vagrant images with the cOS packer templates</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vT-ZugVPCUCffRbfko-tOoTyRIpqjtgvQgQn74lckTZCjMLIakEJKRPwyjFL7tGEmKE8DDMVSZBEZ9u/pub?w=1223&h=691" alt></p><p>Requirements:</p><ul><li>Packer</li><li>Either qemu or VirtualBox functioning in the build host</li><li>a cOS or a <a href=../../build_iso>custom ISO</a></li><li><a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>Packer templates</a></li></ul><p>The suggested approach is based on using <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>Packer templates</a> to customize the
deployment and automate creation of QCOW, Virtualbox and Vagrant images of cOS derivatives or cOS itself. For all the details
and possibilties of Packer check the <a href=https://www.packer.io/guides/hcl>official documentation</a>.</p><h2 id=run-the-build-with-packer>Run the build with Packer</h2><p>To build QCOW and VirtualBox images an ISO file is required. You can either <a href=../../../getting-started/download>Download</a> a cOS ISO or <a href=../../build_iso>build your own from a container image</a>.</p><h3 id=qcow2>QCOW2</h3><p>Consider:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -var <span style=color:#4e9a06>&#34;iso=/path/to/image.iso&#34;</span> -only qemu.cos .
</code></pre></div><p>The process should end up by building a <code>.box</code> file (vagrant image) and a <code>.tar.gz</code> file (containing the raw disk) in the same folder:</p><pre><code>...
==&gt; qemu.cos (compress): Using pgzip compression with 8 cores for cOS_green_dev_amd64.tar.gz
==&gt; qemu.cos (compress): Tarring cOS_green_dev_amd64.tar.gz with pgzip
==&gt; qemu.cos (compress): Archive cOS_green_dev_amd64.tar.gz completed
Build 'qemu.cos' finished after 4 minutes 34 seconds.

==&gt; Wait completed after 4 minutes 34 seconds

==&gt; Builds finished. The artifacts of successful builds are:
--&gt; qemu.cos: 'libvirt' provider box: cOS_green_dev_amd64.box
--&gt; qemu.cos: compressed artifacts in: cOS_green_dev_amd64.tar.gz

&gt; ubuntu@jumpbox:~/cOS-toolkit/packer$ ls -liah
total 2.3G
 516552 drwxrwxr-x  4 ubuntu ubuntu 4.0K Jul 30 07:54 .
 516207 drwxrwxr-x 14 ubuntu ubuntu 4.0K Jul 30 07:41 ..
 516362 -rw-r--r--  1 root   root   1.2G Jul 30 07:54 cOS_green_dev_amd64.box
 516385 -rw-r--r--  1 root   root   1.2G Jul 30 07:54 cOS_green_dev_amd64.tar.gz
 516553 -rw-rw-r--  1 ubuntu ubuntu  389 Jun 28 08:07 config.yaml
 516339 -rw-rw-r--  1 ubuntu ubuntu 6.5K Jul 30 07:41 images.json.pkr.hcl
1818463 drwxrwxr-x  3 ubuntu ubuntu 4.0K Jul 30 07:49 packer_cache
1818400 drwxrwxr-x  2 ubuntu ubuntu 4.0K Jul 30 07:41 user-data
 516555 -rw-rw-r--  1 ubuntu ubuntu  606 Jun 28 08:07 vagrant.yaml
 516340 -rw-rw-r--  1 ubuntu ubuntu 6.1K Jul 30 07:41 variables.pkr.hcl
ubuntu@jumpbox:~/cOS-toolkit/packer$ 
</code></pre><p>The <code>-only qemu.cos</code> flag is just to tell packer which of the sources
to make use for the build. Note the <code>packer/images.json.pkr.hcl</code> file defines
few other sources such as <code>amazon-ebs</code> and <code>virtualbox-iso</code>.</p><h3 id=virtualbox>Virtualbox</h3><p>Similarly, to build OVA images we run:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -var <span style=color:#4e9a06>&#34;iso=/path/to/image.iso&#34;</span> -only virtualbox-iso.cos .
</code></pre></div><h3 id=vagrant>Vagrant</h3><p>To build vagrant images, we enable the <code>vagrant</code> feature, which allows the <code>vagrant</code> user to login afterwards:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -var <span style=color:#4e9a06>&#34;iso=/path/to/image.iso&#34;</span> -var <span style=color:#4e9a06>&#34;feature=vagrant&#34;</span> -only virtualbox-iso.cos .
</code></pre></div><h2 id=customize-the-build-with-a-variables-file>Customize the build with a variables file</h2><p>The packer template can be customized with the variables defined in
<code>packer/variables.pkr.hcl</code>. These are the variables that can be set on run
time using the <code>-var key=value</code> or <code>-var-file=path</code> flags. The variable file
can be a json file including desired varibles. Consider the following example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the packer folder of the cOS-toolkit repository checkout</span>

&gt; cat <span style=color:#4e9a06>&lt;&lt; EOF &gt; test.json
</span><span style=color:#4e9a06>{
</span><span style=color:#4e9a06>    &#34;root_username&#34;: &#34;root&#34;,
</span><span style=color:#4e9a06>    &#34;root_password&#34;: &#34;cos&#34;
</span><span style=color:#4e9a06>}
</span><span style=color:#4e9a06>EOF</span>

&gt; packer build -only qemu.cos -var <span style=color:#4e9a06>&#34;iso=/path/to/image.iso&#34;</span> -var-file<span style=color:#ce5c00;font-weight:700>=</span>test.json .
</code></pre></div><p>The above example runs the build by logging with a different username/password to run the installation.</p><h3 id=default-cloud-init>Default cloud-init</h3><p>In the packer folder there is present a <code>config.yaml</code> file which can be used to customize the image. The file is in <a href=../../../references/cloud-init>cloud-init</a> style and will be automatically installed by default when running <code>cos-install</code>.</p><h3 id=available-variables-for-customization>Available variables for customization</h3><p>All the customizable variables are listed in <code>packer/variables.pkr.hcl</code>,
these are some of the relevant ones:</p><ul><li><p><code>build</code>,<code>flavor</code>,<code>arch</code>: This to personalize the artifact output name. The artifact output format is
<code>"cOS_${var.flavor}_${var.build}_${var.arch}.tar.gz"</code></p></li><li><p><code>disk_size</code>: This sets the disk size to be used for the image. It is 50000 by default, and expressed in MB.</p></li><li><p><code>memory</code>: RAM to allocate to the VM in MB.</p></li><li><p><code>cpu</code>: Number of processors of the VM</p></li><li><p><code>accelerator</code>: Accelerator type, see the <a href=https://www.packer.io/docs/builders/qemu#accelerator>official docs</a></p></li><li><p><code>root_username</code>: Username used to login via ssh, it needs root permissions to be able to run the installation process and call <code>cos-install</code></p></li><li><p><code>root_password</code>: Password for the user specified in <code>root_username</code></p></li><li><p><code>feature</code>: Enable/Disables specific <code>cOS</code> features.</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fb0f854c53f1ba28ad4c2ccf8d24df34>4 - Examples</h1><div class=lead>Examples and recipes for building cOS derivatives</div></div><div class=td-content><h1 id=pg-69286228d8129cf393e95a7cae077086>4.1 - Creating bootable images</h1><div class=lead>This document describes the requirements to create standard container images that can be used for <code>cOS</code> deployments</div><p>You can find the examples below in the <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/examples>examples</a> folder.</p><h2 id=from-standard-images>From standard images</h2><p>Besides using the <code>cos-toolkit</code> toolchain, it&rsquo;s possible to create standard container images which are consumable by the vanilla <code>cOS</code> images (ISO, Cloud Images, etc.) during the upgrade and deploy phase.</p><p>An example of a Dockerfile image can be:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>LUET_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>.16.7<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> quay.io/luet/base:$LUET_VERSION AS luet</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> opensuse/leap:15.3</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>ARCH</span><span style=color:#ce5c00;font-weight:700>=</span>amd64
<span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>ARCH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>ARCH</span><span style=color:#4e9a06>}</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> zypper in -y <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    bash-completion <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    conntrack-tools <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    coreutils <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    curl <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    device-mapper <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    dosfstools <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    dracut <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    e2fsprogs <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    findutils <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    gawk <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    gptfdisk <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    grub2-i386-pc <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    grub2-x86_64-efi <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    haveged <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    iproute2 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    iptables <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    iputils <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    issue-generator <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    jq <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-default <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-bnx2 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-i915 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-intel <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-iwlwifi <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-mellanox <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-network <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-platform <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-realtek <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    less <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    lsscsi <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    lvm2 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    mdadm <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    multipath-tools <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    nano <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    nfs-utils <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    open-iscsi <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    open-vm-tools <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    parted <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    pigz <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    policycoreutils <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    procps <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    python-azure-agent <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    qemu-guest-agent <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    rng-tools <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    rsync <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    squashfs <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    strace <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    systemd <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    systemd-sysvinit <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    tar <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    timezone <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    vim <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    which<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Copy the luet config file pointing to the upgrade repository</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> conf/luet.yaml /etc/luet/luet.yaml<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Copy luet from the official images</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> --from<span style=color:#ce5c00;font-weight:700>=</span>luet /usr/bin/luet /usr/bin/luet<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> luet install -y <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    toolchain/yip <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    utils/installer <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    system/cos-setup <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    system/immutable-rootfs <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    system/grub-config <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    system/cloud-config <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    utils/k9s <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    utils/nerdctl<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> files/ /<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> mkinitrd<span style=color:#a40000>
</span></code></pre></div><small><i class="fab fa-github"></i> <i>Complete source code: <a target=_blank href=https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/Dockerfile>https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/Dockerfile</a></i></small><hr><p>While the config file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>logging</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>color</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable_emoji</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>general</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>debug</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>spinner_charset</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cos&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cOS official&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;docker&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cached</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>priority</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>verify</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>urls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;quay.io/costoolkit/releases-green&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><small><i class="fab fa-github"></i> <i>Complete source code: <a target=_blank href=https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/conf/luet.yaml>https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/conf/luet.yaml</a></i></small><hr><p>We can just run docker to build the image with</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker build -t <span style=color:#000>$IMAGE</span> .
</code></pre></div><p>The important piece is that an image needs to ship at least:</p><pre><code>toolchain/yip
utils/installer
system/cos-setup
system/immutable-rootfs
system/grub-config
system/cloud-config
</code></pre><p>from the toolchain. If you want to customize further the container further add more step afterwards <code>luet install</code> see <a href=../../customizing>the customizing section</a>.</p><p><strong>Note</strong>: Depending on the base image (<code>FROM opensuse/leap:15.3</code> in the sample), you must set the corresponding repository for each flavor <a href=../../getting-started/download#releases>see releases</a> in the luet config file ( which in the sample above points to the <em>green</em> releases )</p><h2 id=generating-from-ci-image>Generating from CI image</h2><p>You can just use the published final images:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#8f5902;font-style:italic># Pick one version from https://quay.io/repository/costoolkit/releases-green?tab=tags</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> quay.io/costoolkit/releases-green:cos-system-0.5.8-4</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> files/ /<span style=color:#a40000>
</span></code></pre></div><small><i class="fab fa-github"></i> <i>Complete source code: <a target=_blank href=https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/cos-official/Dockerfile>https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/cos-official/Dockerfile</a></i></small><hr><h2 id=from-scratch>From scratch</h2><p>The luet image <code>quay.io/luet/base</code> contains just luet, and can be used to boostrap the base system from scratch:</p><p>conf/luet.yaml:<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>logging</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>color</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable_emoji</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>general</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>debug</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>spinner_charset</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cos&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cOS official&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;docker&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cached</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>priority</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>verify</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>urls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;quay.io/costoolkit/releases-green&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><small><i class="fab fa-github"></i> <i>Complete source code: <a target=_blank href=https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/scratch/conf/luet.yaml>https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/scratch/conf/luet.yaml</a></i></small><hr></p><p>Dockerfile:<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>LUET_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>.16.7<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> quay.io/luet/base:$LUET_VERSION AS luet</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> opensuse/leap:15.3 AS ca</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> scratch</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Copy luet from the official images</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> --from<span style=color:#ce5c00;font-weight:700>=</span>luet /usr/bin/luet /usr/bin/luet<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> --from<span style=color:#ce5c00;font-weight:700>=</span>ca /etc/ssl/certs/. /etc/ssl/certs/<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Copy the luet config file pointing to the cOS repository</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ADD</span> conf/luet.yaml /etc/luet/luet.yaml<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>USER</span><span style=color:#ce5c00;font-weight:700>=</span>root
<span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>LUET_NOLOCK</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
<span style=color:#204a87;font-weight:700>SHELL</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;/usr/bin/luet&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;install&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;-y&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;-d&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> system/cos-container<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>SHELL</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;/bin/sh&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;-c&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> rm -rf /var/cache/luet/packages/ /var/cache/luet/repos/<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>TMPDIR</span><span style=color:#ce5c00;font-weight:700>=</span>/tmp<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENTRYPOINT</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;/bin/sh&#34;</span><span style=color:#000;font-weight:700>]</span></code></pre></div><small><i class="fab fa-github"></i> <i>Complete source code: <a target=_blank href=https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/scratch/Dockerfile>https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/scratch/Dockerfile</a></i></small><hr></p><h2 id=customizations>Customizations</h2><p>All the method above imply that the image generated will be the booting one, there are however several configuration entrypoint that you should keep in mind while building the image:</p><ul><li>Everything under <code>/system/oem</code> will be loaded during the various stage (boot, network, initramfs). You can check <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/e411d8b3f0044edffc6fafa39f3097b471ef46bc/packages/cloud-config/oem>here</a> for the <code>cOS</code> defaults. See <code>00_rootfs.yaml</code> to customize the booting layout.</li><li><code>/etc/cos/bootargs.cfg</code> contains the booting options required to boot the image with GRUB</li><li><code>/etc/cos-upgrade-image</code> contains the default upgrade configuration for recovery and the booting system image</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4b878445954ea167a58c44cfb25c7dd2>4.2 - Creating derivatives</h1><div class=lead>This document summarize references to create derivatives with <code>cos-toolkit</code> by using the <code>luet</code> toolchain.</div><p><code>cos-toolkit</code> is a manifest to share a common abstract layer between derivatives inheriting the same featureset.</p><p><code>cos</code> is a <a href=https://luet-lab.github.io/docs/docs/concepts/packages/specfile/#specfiles>Luet tree</a> and derivatives can be expressed as Luet trees as well that inherit part of the compilation specs from <code>cos</code>.</p><p>Those trees are then post-processed and converted to Dockerfiles when building packages, that in turn are used to build docker images and final artefacts.</p><h2 id=high-level-workflow>High level workflow</h2><p>The building workflow can be resumed in the following steps:</p><ul><li>Build packages from container images. This step generates build metadata (<code>luet build</code> / <code>docker build</code> / <code>buildah</code> ..)</li><li>Add repository metadata and create a repository from the build phase (<code>luet create-repo</code>)</li><li>(otherwise, optionally) publish the repository and the artefacts along (<code>luet create-repo --push-images</code>)</li></ul><p>While on the client side, the upgrade workflow is:</p><ul><li><code>luet install</code> (when upgrading from release channels) latest cos on a pristine image file</li><li>or <code>luet util unpack</code> (when upgrading from specific docker images)</li></ul><p><em>Note</em>: The manual build steps are not stable and will likely change until <a href=https://github.com/rancher-sandbox/cOS-toolkit/issues/108>we build a single CLI</a> to encompass the <code>cos-toolkit</code> components, rather use <code>source .envrc && cos-build</code> for the moment being while iterating locally.</p><h2 id=example>Example</h2><p><a href=https://github.com/rancher-sandbox/cos-toolkit-sample-repo>The sample repository</a> has the following layout:</p><pre><code>├── Dockerfile
├── .envrc
├── .github
│   └── workflows
│       ├── build.yaml
│       └── test.yaml
├── .gitignore
├── iso.yaml
├── LICENSE
├── .luet.yaml
├── Makefile
├── packages
│   ├── sampleOS
│   │   ├── 02_upgrades.yaml
│   │   ├── 03_branding.yaml
│   │   ├── 04_accounting.yaml
│   │   ├── build.yaml
│   │   ├── definition.yaml
│   │   └── setup.yaml
│   └── sampleOSService
│       ├── 10_sampleOSService.yaml
│       ├── build.yaml
│       ├── definition.yaml
│       └── main.go
└── README.md
</code></pre><p>In the detail:</p><ul><li>the <code>packages</code> directory is the sample Luet tree that contains the <a href=https://luet-lab.github.io/docs/docs/concepts/packages/specfile/#build-specs>package definitions</a> [1] which composes the derivative.
For an overview of the package syntax and build process, see the <a href=https://luet-lab.github.io/docs/docs/concepts/packages/>official luet documentation</a></li><li><code>.luet.yaml</code> contains a configuration file for <code>luet</code> pointing to the <code>cos</code> repositories, used to fetch packages required in order to build the iso [2] <strong>and</strong> to fetch definitions from [3].</li><li><code>Makefile</code> and <code>.envrc</code> are just wrappers around <code>luet build</code> and <code>luet create-repo</code></li><li><code>iso.yaml</code> a YAML file that describes what packages to embed in the final ISO</li></ul><p><em>Note</em>: There is nothing special in the layout, and neither the <code>packages</code> folder naming is special. By convention we have chosen to put the compilation specs in the <code>packages</code> folder, the <code>Makefile</code> is just calling <code>luet</code> with a set of default parameters according to this setup.</p><p>The <code>.envrc</code> is provided as an example to automatize the build process: it will build a docker image with the required dependencies, check the <a href=../development>development docs</a> about the local requirements if you plan to build outside of docker.</p><p><strong>[1]</strong> <em>In the sample above we just declare two packages: <code>sampleOS</code> and <code>sampleOSService</code>. Their metadata are respectively in <code>packages/sampleOS/definition.yaml</code> and <code>packages/sampleOSService/definition.yaml</code></em></p><p><strong>[2]</strong> <em>We consume <code>live/systemd-boot</code> and <code>live/syslinux</code> from <code>cos</code> instead of building them from the sample repository</em></p><p><strong>[3]</strong> <em>see also <a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample#main-difference-with-cos-toolkit-sample-repo>using git submodules</a> instead</em></p><h2 id=single-image-os>Single image OS</h2><p>Derivatives are composed by a combination of specs to form a final package that is consumed as a single image OS.</p><p>The container image during installation and upgrade, is converted to an image file with a backing ext2 fs.</p><p>In the sample repository <a href=https://github.com/rancher-sandbox/cos-toolkit-sample-repo/blob/master/packages/sampleOS/definition.yaml>we have defined <code>system/sampleOS</code></a> as our package, that will later on will be converted to image.</p><p>Packages in luet have <code>runtime</code> and <code>buildtime</code> specifications into <code>definition.yaml</code> and <code>build.yaml</code> respectively, and in the buildtime we set:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>requires</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;system&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cos&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&gt;=0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;app&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;sampleOSService&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&gt;=0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>This instruct <code>luet</code> to compose a new image from the results of the compilation of the specified packages, without any version constraints, and use it to run any <code>steps</code> and <code>prelude</code> on top of it.</p><p>We are interested in the dependencies final images, and not the containers used to build them, so we enable <code>requires_final_images</code>:</p><pre><code>requires_final_images: true
</code></pre><p>We later run arbitrary steps to tweak the image:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>steps</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>And we instruct luet to compose the final artifact as a <code>squash</code> of the resulting container image, composed of all the files:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>unpack</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>A detailed explaination of all the keywords available <a href=https://luet-lab.github.io/docs/docs/concepts/packages/specfile/#keywords>is in the luet docs</a> along with the <a href=https://luet-lab.github.io/docs/docs/concepts/packages/specfile/#building-strategies>supported build strategies</a>.</p><p>We exclude then a bunch of file that we don&rsquo;t want to be in the final package (regexp supported):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>excludes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>Note</strong>: In the <a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample/blob/19c530ea53ad577e60adbae1d419781fcea808f5/packages/epinioOS/build.yaml#L1>EpinioOS sample</a>, we use <code>requires</code> instead of <code>join</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>requires</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;system&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cos&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&gt;=0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;k3s&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;app&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&gt;=0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;policy&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;selinux&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&gt;=0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>The difference is that with <code>requires</code> we use the <em>building</em> container that was used to build the packages instead of creating a new image from their results: we are not consuming their artifacts in this case, but the environment used to build them. See also <a href=https://luet-lab.github.io/docs/docs/concepts/packages/specfile/#package-source-image>the luet docs</a> for more details.</p><h3 id=building>Building</h3><p>Refering to the <code>sampleOS</code> example, we set the <a href=https://github.com/rancher-sandbox/cos-toolkit-sample-repo/blob/8ed369c6ca76f1fc69e49d8001c689c8d0371d30/Makefile#L13>Makefile</a> accordingly to compile the system package.</p><p>With luet installed locally and docker running, in your git checkout you can build it also by running <code>luet build --tree packages system/sampleOS</code>. This will produce an artifact of <code>system/sampleOS</code>. Similary, we could also build separately the sample application with <code>luet build --tree packages app/sampleOSService</code>.</p><p>The build process by default results in a <code>build</code> folder containing the package and the compilation metadata in order to generate a repository.</p><p><em>Note on reproducibility</em>: See <a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample#main-difference-with-cos-toolkit-sample-repo>the difference between our two samples repositories</a> for an explanation of what are the implications of using a <code>.luet.yaml</code> file for building instead of a git submodule.</p><h2 id=additional-packages>Additional packages</h2><p>In our sample repo we have split the logic of a separate application in <code>app/sampleOSService</code>.</p><p><code>sampleOSService</code> is just an HTTP server that we would like to have permanently in the system and on boot.</p><p>Thus we define it as a dependency in the <code>system/sampleOS</code>&rsquo;s <code>requires</code> section:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>requires</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;app&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;sampleOSService&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&gt;=0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><em>Note</em> If you are wondering about copying just single files, there is <a href=https://github.com/mudler/luet/issues/190>an upstream open issue</a> about it.</p><p>In this way, when building our <code>sampleOS</code> package, <code>luet</code> will automatically apply the compilation spec of our package on top.</p><h2 id=templating>Templating</h2><p>The package <code>build</code> definition supports <a href=https://luet-lab.github.io/docs/docs/concepts/packages/templates/>templating</a>, and global interpolation of build files with multiple values files.</p><p>Values file can be specified during build time in luet with the <code>--values</code> flag (also multiple files are allowed) and, if you are familiar with <code>helm</code> it using the same engine under the hood, so all the functions are available as well.</p><p><code>cos-toolkit</code> itself uses <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/values>default values files</a> for every supported distributions.</p><p>For a more complex example involving values file, <a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample>see the epinio appliance example</a>.</p><p>Templates uses cases are for: resharing common pieces between flavors, building for different platforms and architectures, &mldr;</p><h2 id=build-iso>Build ISO</h2><p>To build an iso from a local repository (the build process, automatically produces a repository in <code>build</code> in the local checkout):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>luet-makeiso ./iso.yaml --local build
</code></pre></div><p>Where <code>iso.yaml</code> is the iso specification file, and <code>--local build</code> is an optional argument to use also the local repository in the build process. See also <a href=../../creating-derivatives/build_iso>building ISOs</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-8dbd4e302cd86a4d0f71f71ce3b300de>5 - Tutorials</h1><div class=lead>cOS tutorials and real life use-case samples</div></div><div class=td-content><h1 id=pg-d57b80651f0651da95da0184bb71b5ba>5.1 - K3s + Fleet</h1><div class=lead>Running k3s and Fleet on a cOS vanilla raw image</div><p>This is a work in progress example of how to deploy K3S + Fleet + System Uprade Controller over a cOS vanilla image only
by using cloud-init yaml configuration files. The config file reproduced here is meant to be included
as a user-data in a cloud provider (aws, gcp, azure, etc) or as part of a cdrom (cOS-Recovery will try to fetch <code>/userdata</code> file
from a cdrom device).</p><p>A vanilla image is an image that only provides the cOS-Recovery system on a <code>COS_RECOVERY</code> partition. It does not include any other
system and it is meant to be dumped to a bigger disk and deploy a cOS system or a derivative system over the free space in disk.
COS vanilla images are build as part of the CI workflow, see CI artifacts to download one of those.</p><p>The configuration file of this example has two purposes: first it deploys cOS, second in reboots on the deployed OS and deploys
K3S + Fleet + System Upgrades Controller.</p><p>On first boot it will fail to boot cOS grub menu entry and fallback
to cOS-Recovery system. From there it will partition the vanilla image to create the main system partition (<code>COS_STATE</code>)
and add an extra partition for persistent data (<code>COS_PERSISTENT</code>). It will use the full disk, a disk of at least 20GiB
is recommended. After partitioning it will deploy the main system on <code>COS_STATE</code> and reboot to it.</p><p>On consequent boots it will simply boot from <code>COS_STATE</code>, there it prepares the persistent areas of the system (arranges few bind
mounts inside <code>COS_PERSISTENT</code>) and then it runs an standard installation of K3s, Fleet and System Upgrade Controller. After few
minutes after the system is up the K3s cluster is up and running.</p><p>Note this setup similar to the <a href=https://github.com/rancher-sandbox/cos-fleet-upgrades-sample>derivative example</a> using Fleet.
The main difference is that this example does not require to build any image, it is pure cloud-init configuration based.</p><h3 id=user-data-configuration-file>User data configuration file</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Default deployment&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>rootfs.after</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Repart image&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>layout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># It will partition a device including the given filesystem label or part label (filesystem label matches first)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>device</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_RECOVERY</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>add_partitions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_STATE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># 15Gb for COS_STATE, so the disk should have, at least, 20Gb</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>15360</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>state</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_PERSISTENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># unset size or 0 size means all available space</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>persistent</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Set /etc/hosts&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/hosts</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>           </span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#0000cf;font-weight:700>127.0.0.1</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#000>localhost</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Persist&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>            target=/usr/local/.cos-state
</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>            # Always want the latest update of systemd conf from the image
</span><span style=color:#8f5902;font-style:italic>            # TODO: This might break the fallback system
</span><span style=color:#8f5902;font-style:italic>            mkdir -p &#34;${target}/etc/systemd/&#34;
</span><span style=color:#8f5902;font-style:italic>            rsync -av /etc/systemd/ &#34;${target}/etc/systemd/&#34;
</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>            # Only populate ssh conf once
</span><span style=color:#8f5902;font-style:italic>            if [ ! -e &#34;${target}/etc/ssh&#34; ]; then
</span><span style=color:#8f5902;font-style:italic>              mkdir -p &#34;${target}/etc/ssh/&#34;
</span><span style=color:#8f5902;font-style:italic>              rsync -av /etc/ssh/ &#34;${target}/etc/ssh/&#34;
</span><span style=color:#8f5902;font-style:italic>            fi
</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>            # undo /home /opt /root mount from cos immutable-rootfs module
</span><span style=color:#8f5902;font-style:italic>            # TODO: we could think of configuring custom overlay paths in
</span><span style=color:#8f5902;font-style:italic>            # immutable rootfs package. So this part could be omitted
</span><span style=color:#8f5902;font-style:italic>            for i in home opt root; do
</span><span style=color:#8f5902;font-style:italic>              sed -i &#34;/overlay \/${i} /d&#34; /etc/fstab
</span><span style=color:#8f5902;font-style:italic>              nsenter -m -t 1 -- umount &#34;/sysroot/${i}&#34;
</span><span style=color:#8f5902;font-style:italic>            done
</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>            # setup directories as persistent
</span><span style=color:#8f5902;font-style:italic>            # TODO: would it make sense defining persistent state overlayfs mounts
</span><span style=color:#8f5902;font-style:italic>            # as part of the immutable rootfs config?
</span><span style=color:#8f5902;font-style:italic>            for i in root opt home var/lib/rancher var/lib/kubelet etc/systemd etc/rancher etc/ssh; do
</span><span style=color:#8f5902;font-style:italic>              mkdir -p &#34;${target}/${i}&#34; &#34;/${i}&#34;
</span><span style=color:#8f5902;font-style:italic>              echo &#34;${target}/${i} /${i} none defaults,bind 0 0&#34; &gt;&gt; /etc/fstab
</span><span style=color:#8f5902;font-style:italic>              nsenter -m -t 1 -- mount -o defaults,bind &#34;/sysroot${target}/${i}&#34; &#34;/sysroot/${i}&#34;
</span><span style=color:#8f5902;font-style:italic>            done
</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>            # ensure /var/log/journal exists so it&#39;s labeled correctly
</span><span style=color:#8f5902;font-style:italic>            mkdir -p /var/log/journal</span><span style=color:#f8f8f8;text-decoration:underline>            
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>network.before</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup SSH keys&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>authorized_keys</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>root</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># It can download ssh key from remote places, such as github user keys (e.g. `github:my_user`)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>my_custom_ssh_key</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Fleet deployment&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/k3s/manifests/fleet-config.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>              apiVersion: helm.cattle.io/v1
</span><span style=color:#8f5902;font-style:italic>              kind: HelmChart
</span><span style=color:#8f5902;font-style:italic>              metadata:
</span><span style=color:#8f5902;font-style:italic>                name: fleet-crd
</span><span style=color:#8f5902;font-style:italic>                namespace: kube-system
</span><span style=color:#8f5902;font-style:italic>              spec:
</span><span style=color:#8f5902;font-style:italic>                chart: https://github.com/rancher/fleet/releases/download/v0.3.3/fleet-crd-0.3.3.tgz
</span><span style=color:#8f5902;font-style:italic>              ---
</span><span style=color:#8f5902;font-style:italic>              apiVersion: helm.cattle.io/v1
</span><span style=color:#8f5902;font-style:italic>              kind: HelmChart
</span><span style=color:#8f5902;font-style:italic>              metadata:
</span><span style=color:#8f5902;font-style:italic>                name: fleet
</span><span style=color:#8f5902;font-style:italic>                namespace: kube-system
</span><span style=color:#8f5902;font-style:italic>              spec:
</span><span style=color:#8f5902;font-style:italic>                chart: https://github.com/rancher/fleet/releases/download/v0.3.3/fleet-0.3.3.tgz</span><span style=color:#f8f8f8;text-decoration:underline>              
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>network</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Deploy cos-system&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># Deploys the latest image available in default channel (quay.io/costoolkit/releases-green)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># use --docker-image to deploy a custom image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># e.g. `cos-deploy --docker-image quay.io/my_custom_repo:my_image`</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>cos-deploy &amp;&amp; shutdown -r now</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup k3s&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>directories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/usr/local/bin&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0755</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>            curl -sfL https://get.k3s.io | \
</span><span style=color:#8f5902;font-style:italic>            INSTALL_K3S_VERSION=&#34;v1.20.4+k3s1&#34; \
</span><span style=color:#8f5902;font-style:italic>            INSTALL_K3S_EXEC=&#34;--tls-san {{.Values.node.hostname}}&#34; \
</span><span style=color:#8f5902;font-style:italic>            INSTALL_K3S_SELINUX_WARN=&#34;true&#34; \
</span><span style=color:#8f5902;font-style:italic>            sh -
</span><span style=color:#8f5902;font-style:italic>            # Install fleet 
</span><span style=color:#8f5902;font-style:italic>            kubectl apply -f /etc/k3s/manifests/fleet-config.yaml
</span><span style=color:#8f5902;font-style:italic>            # Install system-upgrade-controller
</span><span style=color:#8f5902;font-style:italic>            kubectl apply -f https://raw.githubusercontent.com/rancher/system-upgrade-controller/v0.6.2/manifests/system-upgrade-controller.yaml</span><span style=color:#f8f8f8;text-decoration:underline>            
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-7f6aed5f776c4254888a6bcd3e601087>5.2 - Trigger upgrades with K3s and Fleet</h1><div class=lead>Using fleet to trigger upgradeson cOS based derivatives</div><p>In this tutorial we will:</p><ol><li>Build a custom OS image to deploy in our cluster</li><li>Setup a cluster with cOS, k3s and fleet</li><li>Upgrade the cluster to our custom OS image with fleet</li></ol><p><a href=https://github.com/rancher-sandbox/cos-fleet-upgrades-sample/>This repository</a> contains the full example code.</p><h2 id=1-build-the-os-image>1) Build the OS image</h2><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># IMAGE=quay.io/costoolkit/test-images:fleet-sample</span>
<span style=color:#8f5902;font-style:italic># cd os</span>
<span style=color:#8f5902;font-style:italic># docker build -t $IMAGE .</span>
</code></pre></div><h2 id=2-push-the-docker-image>2) Push the docker image</h2><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># docker push $IMAGE</span>
</code></pre></div><h2 id=3-prepare-a-cos-vm>3) Prepare a cOS VM</h2><p>Download an ISO, or a qcow image from the Github artifacts of cOS. Or generate an iso of the image (check <a href=https://github.com/mudler/os2>here</a> for another example).</p><p>If deploying on AWS/openstack/Cloud, use the <code>fleet-cloud-init.yaml</code> file as userdata. If deploying on baremetal/VMs, place <code>fleet-cloud-init.yaml</code> in <code>/oem</code> after install (or run the installer with <code>cos-installer --config https://raw.githubusercontent.com/rancher-sandbox/cos-fleet-upgrades-sample/main/fleet-cloud-init.yaml $DEVICE</code>).</p><p>Reboot, after some bootstraping time (check until all pods are running with <code>watch kubectl get pods -A</code>), you should have a k3s cluster with fleet and <a href=https://github.com/rancher/system-upgrade-controller>system-upgrade-controller</a> deployed.</p><h2 id=4-upgrade-with-fleet>4) Upgrade with fleet</h2><p>Add your fleet repository to the fleet cluster:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat &gt; example.yaml &lt;&lt; <span style=color:#4e9a06>&#34;EOF&#34;</span>
apiVersion: fleet.cattle.io/v1alpha1
kind: GitRepo
metadata:
  name: upgrade
  <span style=color:#8f5902;font-style:italic># This namespace is special and auto-wired to deploy to the local cluster</span>
  namespace: fleet-local
spec:
  <span style=color:#8f5902;font-style:italic># Everything from this repo will be ran in this cluster. You trust me right?</span>
  repo: <span style=color:#4e9a06>&#34;https://github.com/rancher-sandbox/cos-fleet-upgrades-sample&#34;</span>
  branch: <span style=color:#4e9a06>&#34;main&#34;</span>
  paths:
  - manifests
EOF

kubectl apply -f example.yaml
</code></pre></div><p>An example of how to trigger an upgrade with fleet is in <code>manifests/upgrade.yaml</code>. Edit the image with the one generated in the previous steps, and commit it to your <strong>fleet repository</strong>, At this point you should see the upgrade job to kick-in, the system will reboot afterwards.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-8df6ea6904416b571ff9bc73afb50933>6 - Reference</h1><div class=lead>References for cOS derivatives, like common featuresets, high level architecture</div><ul><li><a href=https://github.com/mudler/cOS/projects/1>Github project</a> for a short-term Roadmap</li></ul><h3 id=samples-repositories>Samples repositories</h3><ul><li><a href=https://github.com/rancher-sandbox/cos-fleet-upgrades-sample>Build a derivative and upgrade it with fleet</a></li><li><a href=https://github.com/rancher-sandbox/cos-toolkit-sample-repo>Sample repository</a></li><li><a href=https://github.com/rancher-sandbox/epinio-appliance-demo-sample>EpinioOS sample repository</a></li></ul></div><div class=td-content><h1 id=pg-533eb9e0a241df35bd13c7d531fc6bd3>6.1 - Cloud-init support</h1><div class=lead>Features inherited by cOS derivatives that are also available in the cOS vanilla images</div><p>Below is a reference of all keys available in the cloud-init style files.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#8f5902;font-style:italic># &#34;network&#34; is the stage where network is expected to be up</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#8f5902;font-style:italic># It is called internally when network is available from </span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#8f5902;font-style:italic># the cos-setup-network unit.</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>network</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#8f5902;font-style:italic># Here there are a list of </span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#8f5902;font-style:italic># steps to be run in the network stage</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Some setup happening&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/tmp/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                    </span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0777</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>echo &#34;test&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000>nvidia</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>FOO</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>systctl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>debug.exception-trace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>systemctl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>disable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>start</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>baz</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>mask</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>foobar</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>authorized_keys</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#4e9a06>&#34;github:mudler&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#4e9a06>&#34;ssh-rsa ....&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>dns</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/resolv.conf</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>nameservers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#0000cf;font-weight:700>8.8.8.8</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>ensure_entities</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/passwd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>entity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                  kind: &#34;user&#34;
</span><span style=color:#8f5902;font-style:italic>                  username: &#34;foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  password: &#34;pass&#34;
</span><span style=color:#8f5902;font-style:italic>                  uid: 0
</span><span style=color:#8f5902;font-style:italic>                  gid: 0
</span><span style=color:#8f5902;font-style:italic>                  info: &#34;Foo!&#34;
</span><span style=color:#8f5902;font-style:italic>                  homedir: &#34;/home/foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  shell: &#34;/bin/bash&#34;</span><span style=color:#f8f8f8;text-decoration:underline>                  
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>delete_entities</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/passwd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>entity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                  kind: &#34;user&#34;
</span><span style=color:#8f5902;font-style:italic>                  username: &#34;foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  password: &#34;pass&#34;
</span><span style=color:#8f5902;font-style:italic>                  uid: 0
</span><span style=color:#8f5902;font-style:italic>                  gid: 0
</span><span style=color:#8f5902;font-style:italic>                  info: &#34;Foo!&#34;
</span><span style=color:#8f5902;font-style:italic>                  homedir: &#34;/home/foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  shell: &#34;/bin/bash&#34;</span><span style=color:#f8f8f8;text-decoration:underline>                  
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>providers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#4e9a06>&#34;aws&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#4e9a06>&#34;digitalocean&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/etc/cloud-data&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>The default cloud-config format is split into <em>stages</em> (<em>initramfs</em>, <em>boot</em>, <em>network</em>, <em>initramfs</em>, <em>reconcile</em>, called generically <strong>STAGE_ID</strong> below) <a href=../customizing/stages>see also stages</a> that are emitted internally during the various phases by calling <code>cos-setup STAGE_ID</code>.
<em>steps</em> (<strong>STEP_NAME</strong> below) defined for each stage are executed in order.</p><p>Each cloud-config file is loaded and executed only at the apprioriate stage, this allows further components to emit their own stages at the desired time.</p><div class="pageinfo pageinfo-primary"><p>The <a href=https://github.com/mudler/yip#readme>cloud-init tool</a> can be also run standalone, this helps debugging locally and also during development, you can find separate <a href=https://github.com/mudler/yip/releases/tag/0.9.6>releases here</a>, or just run it with docker:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat <span style=color:#4e9a06>&lt;&lt;EOF | docker run -i --rm quay.io/costoolkit/releases-green:cos-recovery-0.6.0 yip -s test -
</span><span style=color:#4e9a06>stages:
</span><span style=color:#4e9a06> test:
</span><span style=color:#4e9a06> - commands:
</span><span style=color:#4e9a06>   - echo &#34;test&#34;
</span><span style=color:#4e9a06>EOF</span>
</code></pre></div></div><p><em>Note</em>: Each cloud-init option can be either run in <em>dot notation</em> ( e.g. <code>stages.network[0].authorized_keys.user=github:user</code> ) in the boot args or either can supply a cloud-init URL at boot with the <code>cos.setup=$URL</code> parameter.</p><h3 id=compatibility-with-cloud-init-format>Compatibility with Cloud Init format</h3><p>A subset of the official <a href=http://cloudinit.readthedocs.org/en/latest/topics/format.html#cloud-config-data>cloud-config spec</a> is implemented.</p><p>If a yaml file starts with <code>#cloud-config</code> it is parsed as a standard cloud-init and automatically associated it to the <code>boot</code> stage. For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic>#cloud-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>passwd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>groups</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ssh_authorized_keys</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>faaapploo</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ssh_authorized_keys</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>asdd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>runcmd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>write_files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>b64</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CiMgVGhpcyBmaWxlIGNvbnRyb2xzIHRoZSBzdGF0ZSBvZiBTRUxpbnV4</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo/bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;0644&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Is executed at boot, by using the standard <code>cloud-config</code> format.</p><h3 id=stagesstage_idstep_namename><code>stages.STAGE_ID.STEP_NAME.name</code></h3><p>A description of the stage step. Used only when printing output to console.</p><h3 id=stagesstage_idstep_namefiles><code>stages.STAGE_ID.STEP_NAME.files</code></h3><p>A list of files to write to disk.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/tmp/bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                    #!/bin/sh
</span><span style=color:#8f5902;font-style:italic>                    echo &#34;test&#34;</span><span style=color:#f8f8f8;text-decoration:underline>                    
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0777</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namedirectories><code>stages.STAGE_ID.STEP_NAME.directories</code></h3><p>A list of directories to be created on disk. Runs before <code>files</code>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup folders&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>directories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/etc/foo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0600</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namedns><code>stages.STAGE_ID.STEP_NAME.dns</code></h3><p>A way to configure the <code>/etc/resolv.conf</code> file.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup dns&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>dns</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>nameservers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#0000cf;font-weight:700>8.8.8.8</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#0000cf;font-weight:700>1.1.1.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>search</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>foo.bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/etc/resolv.conf.bak&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namehostname><code>stages.STAGE_ID.STEP_NAME.hostname</code></h3><p>A string representing the machine hostname. It sets it in the running system, updates <code>/etc/hostname</code> and adds the new hostname to <code>/etc/hosts</code>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup hostname&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namesysctl><code>stages.STAGE_ID.STEP_NAME.sysctl</code></h3><p>Kernel configuration. It sets <code>/proc/sys/&lt;key></code> accordingly, similarly to <code>sysctl</code>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup exception trace&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>systctl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>debug.exception-trace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_nameauthorized_keys><code>stages.STAGE_ID.STEP_NAME.authorized_keys</code></h3><p>A list of SSH authorized keys that should be added for each user.
SSH keys can be obtained from GitHub user accounts by using the format github:${USERNAME}, similarly for Gitlab with gitlab:${USERNAME}.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup exception trace&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>authorized_keys</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>mudler</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>github:mudler</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#204a87;font-weight:700>ssh-rsa</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namenode><code>stages.STAGE_ID.STEP_NAME.node</code></h3><p>If defined, the node hostname where this stage has to run, otherwise it skips the execution. The node can be also a regexp in the Golang format.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup logging&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>node</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bastion&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_nameusers><code>stages.STAGE_ID.STEP_NAME.users</code></h3><p>A map of users and user info to set. Passwords can be also encrypted.</p><p>The <code>users</code> parameter adds or modifies the specified list of users. Each user is an object which consists of the following fields. Each field is optional and of type string unless otherwise noted.
In case the user is already existing, the entry is ignored.</p><ul><li><strong>name</strong>: Required. Login name of user</li><li><strong>gecos</strong>: GECOS comment of user</li><li><strong>passwd</strong>: Hash of the password to use for this user. Unencrypted strings are supported too.</li><li><strong>homedir</strong>: User&rsquo;s home directory. Defaults to /home/<em>name</em></li><li><strong>no-create-home</strong>: Boolean. Skip home directory creation.</li><li><strong>primary-group</strong>: Default group for the user. Defaults to a new group created named after the user.</li><li><strong>groups</strong>: Add user to these additional groups</li><li><strong>no-user-group</strong>: Boolean. Skip default group creation.</li><li><strong>ssh-authorized-keys</strong>: List of public SSH keys to authorize for this user</li><li><strong>system</strong>: Create the user as a system user. No home directory will be created.</li><li><strong>no-log-init</strong>: Boolean. Skip initialization of lastlog and faillog databases.</li><li><strong>shell</strong>: User&rsquo;s login shell.</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>bastion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>passwd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;strongpassword&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>homedir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&#34;/home/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_nameensure_entities><code>stages.STAGE_ID.STEP_NAME.ensure_entities</code></h3><p>A <code>user</code> or a <code>group</code> in the <a href=https://github.com/mudler/entities>entity</a> format to be configured in the system</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>ensure_entities</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/passwd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>entity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                  kind: &#34;user&#34;
</span><span style=color:#8f5902;font-style:italic>                  username: &#34;foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  password: &#34;x&#34;
</span><span style=color:#8f5902;font-style:italic>                  uid: 0
</span><span style=color:#8f5902;font-style:italic>                  gid: 0
</span><span style=color:#8f5902;font-style:italic>                  info: &#34;Foo!&#34;
</span><span style=color:#8f5902;font-style:italic>                  homedir: &#34;/home/foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  shell: &#34;/bin/bash&#34;</span><span style=color:#f8f8f8;text-decoration:underline>                  
</span></code></pre></div><h3 id=stagesstage_idstep_namedelete_entities><code>stages.STAGE_ID.STEP_NAME.delete_entities</code></h3><p>A <code>user</code> or a <code>group</code> in the <a href=https://github.com/mudler/entities>entity</a> format to be pruned from the system</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>delete_entities</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/passwd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>entity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                  kind: &#34;user&#34;
</span><span style=color:#8f5902;font-style:italic>                  username: &#34;foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  password: &#34;x&#34;
</span><span style=color:#8f5902;font-style:italic>                  uid: 0
</span><span style=color:#8f5902;font-style:italic>                  gid: 0
</span><span style=color:#8f5902;font-style:italic>                  info: &#34;Foo!&#34;
</span><span style=color:#8f5902;font-style:italic>                  homedir: &#34;/home/foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  shell: &#34;/bin/bash&#34;</span><span style=color:#f8f8f8;text-decoration:underline>                  
</span></code></pre></div><h3 id=stagesstage_idstep_namemodules><code>stages.STAGE_ID.STEP_NAME.modules</code></h3><p>A list of kernel modules to load.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000>nvidia</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namesystemctl><code>stages.STAGE_ID.STEP_NAME.systemctl</code></h3><p>A list of systemd services to <code>enable</code>, <code>disable</code>, <code>mask</code> or <code>start</code>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>systemctl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#000>systemd-timesyncd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#000>cronie</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>mask</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#000>purge-kernels</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>disable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#000>crond</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>start</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#000>cronie</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_nameenvironment><code>stages.STAGE_ID.STEP_NAME.environment</code></h3><p>A map of variables to write in <code>/etc/environment</code>, or otherwise specified in <code>environment_file</code></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>FOO</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_nameenvironment_file><code>stages.STAGE_ID.STEP_NAME.environment_file</code></h3><p>A string to specify where to set the environment file</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>environment_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/home/user/.envrc&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>FOO</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_nametimesyncd><code>stages.STAGE_ID.STEP_NAME.timesyncd</code></h3><p>Sets the <code>systemd-timesyncd</code> daemon file (<code>/etc/system/timesyncd.conf</code>) file accordingly. The documentation for <code>timesyncd</code> and all the options can be found <a href=https://www.freedesktop.org/software/systemd/man/timesyncd.conf.html>here</a>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup NTP&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>systemctl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>systemd-timesyncd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>timesyncd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>NTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;0.pool.org foo.pool.org&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>FallbackNTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namecommands><code>stages.STAGE_ID.STEP_NAME.commands</code></h3><p>A list of arbitrary commands to run after file writes and directory creation.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup something&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>echo 1 &gt; /bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namedatasource><code>stages.STAGE_ID.STEP_NAME.datasource</code></h3><p>Sets to fetch user data from the specified cloud providers. It populates
provider specific data into <code>/run/config</code> folder and the custom user data
is stored into the provided path.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Fetch cloud provider&#39;s user data&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>providers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#4e9a06>&#34;aws&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#4e9a06>&#34;digitalocean&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/etc/cloud-data&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namelayout><code>stages.STAGE_ID.STEP_NAME.layout</code></h3><p>Sets additional partitions on disk free space, if any, and/or expands the last
partition. All sizes are expressed in MiB only and default value of <code>size: 0</code>
means all available free space in disk. This plugin is useful to be used in
oem images where the default partitions might not suit the actual disk geometry.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Repart disk&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>layout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>device</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#8f5902;font-style:italic># It will partition a device including the given filesystem label</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#8f5902;font-style:italic># or partition label (filesystem label matches first) or the device</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#8f5902;font-style:italic># provided in &#39;path&#39;. The label check has precedence over path when</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#8f5902;font-style:italic># both are provided.</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;COS_RECOVERY&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/dev/sda&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># Only last partition can be expanded and it happens before any other</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># partition is added. size: 0 or unset means all available free space</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>expand_partition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4096</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>add_partitions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;COS_STATE&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># No partition label is applied if omitted</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;state&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;COS_PERSISTENT&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># default filesystem is ext2 if omitted</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>filesystem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;ext4&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-a613d9ac188d10fa2f1061ed6e241893>6.2 - Derivatives featureset</h1><div class=lead>Features inherited by cOS derivatives that are also available in the cOS vanilla images</div><h2 id=runtime-features>Runtime features</h2><p>There are present default cloud-init configurations files available under <code>/system/features</code> for example purposes, and to quickly enable testing features.</p><p>Features are simply cloud-config yaml files in the above folder and can be enabled/disabled with <code>cos-feature</code>. For example, after install, to enable <code>k3s</code> it&rsquo;s sufficient to type <code>cos-feature enable k3s</code> and reboot. Similarly, by adding a yaml file in the above folder will make it available for listing/enable/disable.</p><p>See <code>cos-feature list</code> for the available features.</p><pre><code>$&gt; cos-feature list

====================
cOS features list

To enable, run: cos-feature enable &lt;feature&gt;
To disable, run: cos-feature disable &lt;feature&gt;
====================

- carrier
- harvester
- k3s
- vagrant (enabled)
...
</code></pre><h2 id=selinux-policy>SELinux policy</h2><p>By default, derivatives have <code>SELinux</code> enabled in permissive mode. You can use the <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packages/selinux-policies>cos-toolkit</a> default policy as a kickstart to customize on top.</p><p>Copy the package (create a new folder with <code>build.yaml</code>, <code>definition.yaml</code> and <code>cOS.te</code>) into the derivative tree and customize to suit your needs, and add it as a build requirement to your OS package.</p><p><em>Note</em>: the <a href=https://github.com/rancher-sandbox/cOS-toolkit/blob/master/packages/selinux-policies/cOS.te>cOS.te</a> sample policy was created using the utility <code>audit2allow</code> after running some
basic operations in permissive mode using system default policies. <code>allow2audit</code>
translates audit messages into allow/dontaudit SELinux policies which can be later
compiled as a SELinux module. This is the approach used in this illustration
example and mostly follows <code>audit2allow</code> <a href=https://linux.die.net/man/1/audit2allow>man pages</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-bd2c7a111cdf07391221b169f69faaa1>6.3 - Known issues</h1><div class=lead>This document encompasses known issues while building cOS and cOS derivatives.</div><p>When building cOS or a cOS derivative, you could face different issues, this section provides a description of the most known ones, and way to workaround them.</p><h3 id=building-selinux-fails>Building SELinux fails</h3><p><code>cOS</code> by default has SELinux enabled in permissive mode. If you are building parts of cOS or cOS itself from scratch, you might encounter issues while building the SELinux module, like so:</p><pre><code>Step 12/13 : RUN checkmodule -M -m -o cOS.mod cOS.te &amp;&amp; semodule_package -o cOS.pp -m cOS.mod
  ---&gt; Using cache
 ---&gt; 1be520969ead
Step 13/13 : RUN semodule -i cOS.pp
  ---&gt; Running in c5bfa5ae92e2
 libsemanage.semanage_commit_sandbox: Error while renaming /var/lib/selinux/targeted/active to /var/lib/selinux/targeted/previous. (Invalid cross-device link).
semodule:  Failed!
 The command '/bin/sh -c semodule -i cOS.pp' returned a non-zero code: 1
 Error: while resolving join images: failed building join image: Failed compiling system/selinux-policies-0.0.6+3: failed building package image: Could not push image: raccos/sampleos:ffc8618ecbfbffc11cc3bca301cc49867eb7dccb623f951dd92caa10ced29b68 selinux-policies-system-0.0.6+3.dockerfile: Could not build image: raccos/sampleos:ffc8618ecbfbffc11cc3bca301cc49867eb7dccb623f951dd92caa10ced29b68 selinux-policies-system-0.0.6+3.dockerfile: Failed running command: : exit status 1
 Bailing out
make: *** [Makefile:45: build] Error 1
</code></pre><p>The issue is possibly caused by <a href=https://github.com/docker/for-linux/issues/480>https://github.com/docker/for-linux/issues/480</a> . A workaround is to switch the storage driver of Docker. Check if your storage driver is overlay2, and switch it to <code>devicemapper</code></p><h3 id=multi-stage-copy-build-fails>Multi-stage copy build fails</h3><p>While processing images with several stage copy, you could face the following:</p><pre><code> 🐋  Building image raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d done
 📦  8/8 system/cos-0.5.3+1 ⤑ 🔨  build system/selinux-policies-0.0.6+3 ✅  Done
 🚀  All dependencies are satisfied, building package requested by the user system/cos-0.5.3+1
 📦  system/cos-0.5.3+1  Using image:  raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d
 📦  system/cos-0.5.3+1 🐋  Generating 'builder' image from raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d as raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed with prelude steps
🚧  warning Failed to download 'raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed'. Will keep going and build the image unless you use --fatal
🚧  warning Failed pulling image: Error response from daemon: manifest for raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed not found: manifest unknown: manifest unknown
: exit status 1
 🐋  Building image raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed
 Sending build context to Docker daemon  9.728kB
 Step 1/10 : FROM raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d
  ---&gt; f1122e79b17e
Step 2/10 : COPY . /luetbuild
  ---&gt; 4ff3e202951b
 Step 3/10 : WORKDIR /luetbuild
  ---&gt; Running in 7ec571b96c6f
 Removing intermediate container 7ec571b96c6f
  ---&gt; 9e05366f830a
Step 4/10 : ENV PACKAGE_NAME=cos
  ---&gt; Running in 30297dbd21a3
 Removing intermediate container 30297dbd21a3
  ---&gt; 4c4838b629f4
 Step 5/10 : ENV PACKAGE_VERSION=0.5.3+1
  ---&gt; Running in 36361b617252
 Removing intermediate container 36361b617252
  ---&gt; 6ac0d3a2ff9a
Step 6/10 : ENV PACKAGE_CATEGORY=system
  ---&gt; Running in f20c2cf3cf34
 Removing intermediate container f20c2cf3cf34
  ---&gt; a902ff95d273
 Step 7/10 : COPY --from=quay.io/costoolkit/build-cache:f3a333095d9915dc17d7f0f5629a638a7571a01dcf84886b48c7b2e5289a668a /usr/bin/yip /usr/bin/yip
  ---&gt; 42fa00d9c990
 Step 8/10 : COPY --from=quay.io/costoolkit/build-cache:e3bbe48c6d57b93599e592c5540ee4ca7916158461773916ce71ef72f30abdd1 /usr/bin/luet /usr/bin/luet
 e3bbe48c6d57b93599e592c5540ee4ca7916158461773916ce71ef72f30abdd1: Pulling from costoolkit/build-cache
 3599716b36e7:  Already exists
 24a39c0e5d06: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 378615c429f5: Already exists
 c28da22d3dfd:  Already exists
 ddb4dd5c81b0: Already exists
 92db41c0c9ab: Already exists
 4f4fb700ef54: Already exists
 6e0ca71a6514: Already exists
 47debb886c7d: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 d0c9d0f8ddb6: Already exists
 e5a48f1f72ad:  Pulling fs layer
 4f4fb700ef54:  Pulling fs layer
 7d603b2e4a37:  Pulling fs layer
 64c4d787e344:  Pulling fs layer
 f8835d2e60d1:  Pulling fs layer
 64c4d787e344:  Waiting
 f8835d2e60d1:  Waiting
 e5a48f1f72ad:  Download complete
 e5a48f1f72ad:  Pull complete
 4f4fb700ef54:  Verifying Checksum
 4f4fb700ef54:  Download complete
 4f4fb700ef54:  Pull complete
 7d603b2e4a37: Verifying Checksum
7d603b2e4a37: Download complete
 64c4d787e344: Verifying Checksum
64c4d787e344: Download complete
 7d603b2e4a37: Pull complete
 64c4d787e344: Pull complete
 f8835d2e60d1:  Verifying Checksum
 f8835d2e60d1:  Download complete
 f8835d2e60d1: Pull complete
 Digest: sha256:9b58bed47ff53f2d6cc517a21449cae686db387d171099a4a3145c8a47e6a1e0
 Status: Downloaded newer image for quay.io/costoolkit/build-cache:e3bbe48c6d57b93599e592c5540ee4ca7916158461773916ce71ef72f30abdd1
 failed to export image: failed to create image: failed to get layer sha256:118537d8997a08750ab1ac3d8e8575e40fe60e8337e02633b0d8a1287117fe78: layer does not exist
 Error: while resolving join images: failed building join image: failed building package image: Could not push image: raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d cos-system-0.5.3+1-builder.dockerfile: Could not build image: raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d cos-system-0.5.3+1-builder.dockerfile: Failed running command: : exit status 1
 Bailing out
make: *** [Makefile:45: build] Error 1
</code></pre><p>There is a issue open <a href=https://github.com/moby/moby/issues/37965>upstream</a> about it. A workaround is to enable Docker buildkit with <code>DOCKER_BUILDKIT=1</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cf896bdd96bc95a1c5079a49e2dd0b00>6.4 - Immutable Root Filesystem</h1><div class=lead>Immutable root filesystem configuration parameters</div><p>The immutable rootfs concept in cOS is provided by a dracut module which is
basically the contents of the <code>immutable-rootfs</code> luet package provided as part
of the cOS repository tree.</p><p>The dracut module is mostly configured via kernel command line parameters or
via the <code>/run/cos/cos-layout.env</code> environment file.</p><p>The immutable rootfs module is the responsible of mounting the root tree at
boot time with the immutable specific setup. The immutability concept refers
to read only root (<code>/</code>) system. To ensure the linux OS is still functional
certain paths or areas are required to be writable, in those cases an
ephemeral overaly tmpfs is set in place. Additionaly, the immutable rootfs
module can also mount a custom list of device blocks with read write
permissions, those are mostly devoted to store persistent data.</p><p>These are the read write paths the module mounts as part of the overlay
ephemeral tmpfs: <code>/etc</code>, <code>/root</code>, <code>/home</code>, <code>/opt</code>, <code>/srv</code>, <code>/usr/local</code>
and <code>/var</code>.</p><p>These paths will be all ephemeral unless there is a block device configured
to be mounted in the same path.</p><p>It is important to remark all the immutable root configuration is applied
in initrd before switching root and after <code>rootfs</code> cloud-init stage but
before <code>initramfs</code> stage. So immutable rootfs configuration via cloud-init
using the <code>/run/cos/cos-layout.env</code> file is only effective if called in any
of the <code>rootfs.before</code>, <code>rootfs</code> or <code>rootfs.after</code> cloud-init stages.</p><h2 id=kernel-configuraton-paramters>Kernel configuraton paramters</h2><p>The immutable rootfs can be configured witht he following kernel parameters:</p><ul><li><p><code>cos-img/filename=&lt;imgfile></code>: This is one of the main parameters, it defines
the location of the image file to boot from.</p></li><li><p><code>rd.cos.overlay=tmpfs:&lt;size></code>: This defines the size of the tmpfs used for
the ephemeral overlayfs. It can be expressed in MiB or as a % of the available
memory. Defaults to <code>rd.cos.overlay=tmpfs:20%</code> if not present.</p></li><li><p><code>rd.cos.overlay=LABEL=&lt;vol_label></code>: Optionally and mostly for debugging
purposes the overlayfs can be mounted on top of a persistent block device.
Block devices can be expressed by LABEL (<code>LABEL=&lt;blk_label></code>) or by UUID
(<code>UUID=&lt;blk_uuid></code>)</p></li><li><p><code>rd.cos.mount=LABEL:&lt;blk_label>:&lt;mountpoint></code>: This option defines a
persistent block device and its mountpoint. Block devices can also be
defined by UUID (<code>UUID=&lt;blk_uuid>:&lt;mountpoint></code>). This option can be passed
multiple times.</p></li><li><p><code>rd.cos.oemtimeout=&lt;seconds></code>: cOS by default assumes the existence of a
persistent block device labelled <code>COS_OEM</code> which is used to keep some
configuration data (mostly cloud-init files). The immutable rootfs tries
to mount this device at very early stages of the boot even before applying
the immutable rootfs configs. It done this way to enable to configure the
immutable rootfs module within the cloud-init files. As the <code>COS_OEM</code> device
might not be always present the boot process just continues without failing
after a certain timeout. This option configures such a timeout. Defaults to
10s.</p></li><li><p><code>rd.cos.debugrw</code>: This is a boolean option, true if present, false if not.
This option sets the root image to be mounted as a writable device. Note this
completely breaks the concept of an immutable root. This is helpful for
debugging or testing purposes, so changes persist across reboots.</p></li><li><p><code>rd.cos.disable</code>: This is a boolean option, true if present, false if not.
It disables the execution of any immutable rootfs module logic at boot.</p></li></ul><h3 id=configuration-with-an-environment-file>Configuration with an environment file</h3><p>The immutable rootfs can be configured with the <code>/run/cos/cos-layout.env</code>
environment file. It is important to note that all the immutable root
configuration is applied in initrd before switching root and after
<code>rootfs</code> cloud-init stage but before <code>initramfs</code> stage. So immutable rootfs
configuration via cloud-init using the <code>/run/cos/cos-layout.env</code> file is
only effective if called in any of the <code>rootfs.before</code>, <code>rootfs</code> or
<code>rootfs.after</code> cloud-init stages.</p><p>In the environment file only few options are available:</p><ul><li><p><code>VOLUMES=LABEL=&lt;blk_label>:&lt;mountpoint></code>: This variable expects a block device
and it mountpoint pair space separated list. The default cOS configuration is:</p><p><code>VOLUMES="LABEL=COS_OEM:/oem LABEL=COS_PERSISTENT:/usr/local"</code></p></li><li><p><code>OVERLAY=</code>: It defines the underlaying device for the overlayfs as in
<code>rd.cos.overlay=</code> kernel parameter.</p></li><li><p><code>DEBUGRW=true</code>: Sets the root (<code>/</code>) to be mounted with read/write permissions.</p></li><li><p><code>MERGE=true</code>: Sets makes the <code>VOLUMES</code> values to be merged with any other
volume that might have been defined in the kernel command line. The merging
criteria is simple: any overlapping volume is overwritten all others are
appended to whatever was already defined as a kernel parameter. If not
defined defaults to <code>true</code>.</p></li></ul><p>For exmaple a common cOS configuration can is expressed as part of the
cloud-init configuration as follows:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Layout configuration&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>environment_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/run/cos/cos-layout.env</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>VOLUMES</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;LABEL=COS_OEM:/oem LABEL=COS_PERSISTENT:/usr/local&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>OVERLAY</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;tmpfs:25%&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-52dc75d922e47809f6e4b3a9ac43e7a8>6.5 - High level architecture</h1><div class=lead>High level architecture of cOS and its components.</div><h1 id=cos-toolkit-high-level-architecture>cOS toolkit High level Architecture</h1><p>This page tries to encompass the <a href=https://github.com/rancher-sandbox/cOS-toolkit><code>cos-toolkit</code></a> structure and the high level architecture, along with all the involved components.</p><h2 id=design-goals>Design goals</h2><ul><li>Blueprints to build immutable Linux derivatives from container images</li><li>A workflow to maintain, support and deliver custom-OS and upgrades to end systems</li><li>Derivatives have the same “foundation” manifest - easy to customize on top, add packages: <code>systemd</code>, <code>dracut</code> and <code>grub</code> as a foundation stack.</li><li>Upgrades delivered with container registry images ( also workflow with <code>docker run</code> && <code>docker commit</code> supported! )<br>The content of the container image is the system which is booted.</li></ul><h2 id=high-level-overview>High level overview</h2><p>cOS-Toolkit encompasses several components required for building and distributing OS images. <a href=https://github.com/rancher-sandbox/cOS-toolkit/issues/108>This issue</a> summarize the current state, and how we plan to integrate them in a single CLI to improve the user experience.</p><p>cOS-Toolkit is also a manifest, which includes package definitions of how the underlying OS is composed. It forms an abstraction layer, which is then translated to Dockerfiles and built by our CI (optionally) for re-usal. A derivative can be built by parts of the manifest, or reusing it entirely, container images included.</p><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vQQJOaISPbMxMYU44UT-M3ou9uGYOrzbXCRXMLPU8m7_ie3ke_08xCsyRLkFZJRB4VnzIeobPciEoQv/pub?w=942&h=532" alt="High level overview"></p><p>The fundamental phases can be summarized in the following steps:</p><ul><li>Build packages from container images (and optionally keep build caches)</li><li>Extract artefacts from containers</li><li>Add metadata(s) and create a repository</li><li>(optionally) publish the repository and the artefacts</li></ul><p>The developer of the derivative applies a customization layer during build, which is an augmentation layer in the same form of <code>cos-toolkit</code> itself. <a href=https://github.com/rancher-sandbox/cos-toolkit-sample-repo>An example repository is provided</a> that shows how to build a customOS that can be maintained with a container image registry.</p><h2 id=distribution>Distribution</h2><p>The OS delivery mechanism is done via container registries. The developer that wants to provide upgrades for the custom OS will push the resulting container images to the container registry. It will then be used by the installed system to pull upgrades from.</p><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vQrTArCYgu-iscf29v1sl1sEn2J81AqBpi9D5xpwGKr9uxR2QywoSqCmsSaJLxRRacoRr0Kq40a7jPF/pub?w=969&h=464" alt></p><h2 id=upgrade-mechanism>Upgrade mechanism</h2><p>There are two different upgrade mechanisms available that can be used from a maintainer perspective: (a) release channels or (b) providing a container image reference ( <code>e.g. my.registry.com/image:tag</code> ) <a href=https://github.com/rancher-sandbox/cOS-toolkit#default-oem>that can be tweaked in the customization phases</a> to achieve the desired effect.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-39f3813de34ce5cae320697c88e2a917>7 - Development</h1><div class=lead>How to build cOS?</div><p>Welcome!</p><p>The cOS (containerized OS) distribution is entirely built over GitHub. You can check the pipelines in the <code>.github</code> folder to see how the process looks like.</p><h2 id=repository-layout>Repository layout</h2><ul><li><code>packages</code>: contain packages definition for luet</li><li><code>values</code>: interpolation files, needed only for multi-arch and flavor-specific build</li><li><code>assets</code>: static files needed by the iso generation process</li><li><code>packer</code>: Packer templates</li><li><code>tests</code>: cOS test suites</li><li><code>manifest.yaml</code>: Is the manifest needed used to generate the ISO and additional packages to build</li></ul><h2 id=forking-and-test-on-your-own>Forking and test on your own</h2><p>By forking the <code>cOS-toolkit</code> repository, you already have the Github Action workflow configured to start building and pushing your own <code>cOS</code> fork.</p><p>The only changes required to keep in mind for pushing images:</p><ul><li>set <code>DOCKER_PASSWORD</code> and <code>DOCKER_USERNAME</code> as Github secrets, which are needed to push the resulting container images from the pipeline.</li><li>Tweak or set the <code>Makefile</code>&rsquo;s <code>REPO_CACHE</code> and <code>FINAL_REPO</code> accordingly. Those are used respectively for an image used for cache, and for the final image reference.</li></ul><p>Those are not required for building - you can disable image push (<code>--push</code>) from the <code>Makefile</code> or just by specifying e.g. <code>BUILD_ARGS=--pull</code> when calling the <code>make</code> targets.</p><h2 id=building-locally>Building locally</h2><p>cOS has a container image which can be used to build cOS locally in order to generate the cOS packages and the cOS iso from your checkout.</p><p>From your git folder:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; docker build -t cos-builder .
$&gt; docker run --privileged<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --rm -v /var/run/docker.sock:/var/run/docker.sock -v <span style=color:#000>$PWD</span>:/cOS cos-builder
</code></pre></div><p>or use the <code>.envrc</code> file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; <span style=color:#204a87>source</span> .envrc
$&gt; cos-build
</code></pre></div><h3 id=build-all-packages-locally>Build all packages locally</h3><p>Building locally has a <a href=dependencies.md>set of dependencies</a> that
should be satisfied.</p><p>Then you can run</p><pre><code># make build
</code></pre><p>as root</p><p>To clean from previous runs, run <code>make clean</code>.</p><p><em>Note</em>: The makefile uses <a href=dev.md#yq-and-jq><code>yq</code> and <code>jq</code></a> to
retrieve the packages to build from the iso specfile.</p><p>If you don&rsquo;t have <code>jq</code> and <code>yq</code> installed, you must pass by the packages manually with <code>PACKAGES</code> (e.g. <code>PACKAGES="system/cos live/systemd-boot live/boot live/syslinux"</code>).</p><p>You might want to build packages running as <code>root</code> or <code>sudo -E</code> if you intend to preserve file permissions in the resulting packages (mainly for <code>xattrs</code>, and so on).</p><h3 id=build-iso>Build ISO</h3><p>If using SLES or openSUSE, first install the required deps:</p><pre><code># zypper in -y squashfs xorriso dosfstools
</code></pre><p>and then, simply run</p><pre><code># make local-iso
</code></pre><h3 id=testing-iso-changes>Testing ISO changes</h3><p>To test changes against a specific set of packages, you can for example:</p><pre><code># make PACKAGES=&quot;toolchain/yq&quot;  build local-iso
</code></pre><p>root is required because we want to keep permissions on the output packages (not really required for experimenting).</p><h3 id=run-with-qemu>Run with qemu</h3><p>After you have the iso locally, run</p><pre><code>
$&gt; QEMU=qemu-system-x86_64 make run-qemu

</code></pre><p>This will create a disk image at <code>.qemu/drive.img</code> and boot from the ISO.</p><blockquote><p>If the image already exists, it will NOT be overwritten.</p><p>You need to run an explicit <code>make clean_run</code> to wipe the image and
start over.</p></blockquote><h4 id=installing>Installing</h4><p>With a fresh <code>drive.img</code>, <code>make run-qemu</code> will boot from ISO. You can then log in as <code>root</code> with password <code>cos</code> and install cOS on
the disk image with:</p><pre><code># cos-installer /dev/sda
</code></pre><h4 id=running>Running</h4><p>After a successful installation of cOS on <code>drive.img</code>, you can boot
the resulting sytem with</p><pre><code>
$&gt; QEMU_ARGS=&quot;-boot c&quot; make run-qemu

</code></pre><h3 id=run-tests>Run tests</h3><p>Requires: Virtualbox or libvirt, vagrant, packer</p><p>We have a test suite which runs over SSH.</p><p>To create the vagrant image:</p><pre><code>
$&gt; PACKER_ARGS=&quot;-var='feature=vagrant' -only virtualbox-iso&quot; make packer

</code></pre><p>To run the tests:</p><pre><code>
$&gt; make test

</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-8a9a15a61c107bad2b137d10597cb9e8>7.1 - Build Raw images</h1><div class=lead>This section documents the procedure to build cOS raw images which are used to boot into Cloud providers.</div><p>Requirements:</p><ul><li>cOS-toolkit source</li></ul><p>The suggested approach high level view is building cOS packages and generating a RAW image from
them. That would allow us to transform that RAW image in a valid Azure/Google/Amazon Cloud blob that can be transformed into a VM image ready
to be launched.</p><p>This generates a <code>vanilla</code> image that boots into <a href=../../getting-started/recovery>recovery mode</a> and can be used to deploy
whatever image you want to the VM. Then you can snapshot that VM into a VM image ready to deploy with the default cOS
system or your derivative.</p><p>The RAW image can then be used into packer templates to generate custom Images, or used as-is with a userdata to deploy a container image of choice with an input user-data.</p><h2 id=building-the-packages>Building the packages</h2><p>We need to have the packages built locally in order to generate a proper RAW image. Just run:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo make build
</code></pre></div><p>All the artifacts will be generated under the <code>build</code> directory.</p><h2 id=building-the-raw-image>Building the RAW image</h2><p>The RAW image is just a RAW disk image that contains the recovery, so once launched is ready to be used for installing
whatever cOS or derivative that you want into the VM disks. This allows us to have a barebones base image that can be
used for provisioning whatever cOS you want.</p><p>Building the RAW image is as simple as running:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo make raw_disk
</code></pre></div><p>This will output a <code>disk.raw</code> file in the current directory which can be run with qemu, see <a href=../getting-started/booting>booting</a>.</p><h3 id=aws>AWS</h3><p>No other steps are required, the raw disk can be already booted as an AMI image, see <a href=../getting-started/booting>booting</a>.</p><h3 id=azure>Azure</h3><p>Requirements:</p><ul><li>Azure Cloud access keys with the appropriate roles and permissions</li><li><a href=https://docs.microsoft.com/en-us/cli/azure/install-azure-cli>azure-cli</a></li></ul><h4 id=transform-the-raw-image-into-a-compatible-azure-cloud-blob>Transform the RAW image into a compatible Azure Cloud blob</h4><p>Currently importing images from storage blobs on Azure Cloud have a <a href=https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-upload-generic>few requirements</a>:</p><ul><li>only fixed VHD format is supported</li><li>VHD disk must have a virtual size aligned to 1 MB</li><li>LVM is not supported</li><li>no swap partition</li></ul><p>We provide a make target that will do this for you:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo make azure_disk
</code></pre></div><p>This will create a <code>disk.vhd</code> which is our final artifact</p><h4 id=uploading-to-azure-cloud-storage-and-importing-it-as-an-image>Uploading to Azure Cloud storage and importing it as an image</h4><p>The last step is to upload the blob to Azure Cloud storage and import that blob as a valid image.</p><p>With <a href=https://docs.microsoft.com/en-us/cli/azure/install-azure-cli>azure-cli</a> installed
and its credentials configured, you upload the blob with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az storage copy --source &lt;cos-azure-image&gt; --destination https://&lt;account&gt;.blob.core.windows.net/&lt;container&gt;/&lt;destination-cos-azure-image&gt;
</code></pre></div><p>And import it as an image with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az image create --resource-group &lt;resource-group&gt; --source https://&lt;account&gt;.blob.core.windows.net/&lt;container&gt;/&lt;cos-azure-image&gt; --os-type linux --hyper-v-generation v2 --name &lt;image-name&gt;
</code></pre></div><p>Where cos-azure-image is the blob we just uploaded, basically you can use the same value as you set in <code>--destionation</code> for the upload</p><p>Note that we used <code>--os-type linux --hyper-v-generation v2</code> as flags. This indicates that the image will be booted with UEFI
and its required. Otherwise, launching the image will try to boot it in legacy mode, and it will fail.</p><p>Once this is over you will have you cOS (or derivative) vanilla image ready for consumption.
You can see your new image by running:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az image show --resource-group &lt;resource-group&gt; --name &lt;image-name&gt;
</code></pre></div><h3 id=google-cloud>Google cloud</h3><p>Requirements:</p><ul><li>Google Cloud access keys with the appropriate roles and permissions</li><li><a href=https://cloud.google.com/storage/docs/gsutil>gsutil</a> and <a href=https://cloud.google.com/sdk>gcloud</a> tools</li></ul><h4 id=transform-the-raw-image-into-a-compatible-google-cloud-blob>Transform the RAW image into a compatible Google Cloud blob</h4><p>Currently importing images from storage blobs on Google Cloud have a <a href=https://cloud.google.com/compute/docs/import/import-existing-image#requirements_for_the_image_file>few requirements</a>:</p><ul><li>blobs have to be tar.gzipped with the flag <code>--format=oldgnu</code></li><li>the disk.raw has to be rounded up to the next Gb ( so no 2.1gb images or 2.4, they need to be an exact 3Gb or 2Gb)</li><li>image inside the tar.gzip blob needs to be called disk.raw</li></ul><p>We provide a make target that will do this for you:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo make gce_disk
</code></pre></div><p>This will create a <code>disk.raw.tar.gz</code> which is our final artifact</p><h4 id=uploading-to-google-cloud-storage-and-importing-it-as-an-image>Uploading to Google Cloud storage and importing it as an image</h4><p>The last step is to upload the blob to Google Cloud storage and import that blob as a valid image.</p><p>With <a href=https://cloud.google.com/storage/docs/gsutil>gsutil</a> and <a href=https://cloud.google.com/sdk>gcloud</a> tools installed
and their credentials configured, you upload the blob with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gsutil cp disk.raw.tar.gz gs://YOURBUCKET/
</code></pre></div><p>Where YOURBUCKET is the destination bucket you want your file to end up in.</p><p>And import it as an image with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gcloud compute images create IMAGENAME --source-uri<span style=color:#ce5c00;font-weight:700>=</span>SOURCEURI --guest-os-features<span style=color:#ce5c00;font-weight:700>=</span>UEFI_COMPATIBLE
</code></pre></div><p>Where:</p><ul><li>IMAGENAME: The name for the final image</li><li>SOURCEURI: The full Google Cloud Storage URI where the disk image is stored.
This file must be a gzip-compressed tarball whose name ends in
.tar.gz.
This is the full path to the blob we just uploaded.</li></ul><p>Note that we used <code>--guest-os-features=UEFI_COMPATIBLE</code> as a flag. This indicates that the image will be booted with UEFI
and its required. Otherwise, launching the image will try to boot it in legacy mode and it will fail.</p><p>Once this is over you will have you cOS (or derivative) vanilla image ready for consumption.
You can see your new image by running:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gcloud compute images describe IMAGENAME
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-b891fcefc8f5da3d313248bffe32998d>7.2 - Build requirements</h1><div class=lead>Building prerequisites</div><h3 id=installing-required-dependencies-for-local-build>Installing required dependencies for local build</h3><p>To get requirements installed locally, run:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; make deps
</code></pre></div><p>or you need:</p><ul><li><a href=https://github.com/mudler/luet><code>luet</code></a></li><li><a href=https://github.com/mudler/luet-makeiso><code>luet-makeiso</code></a></li><li><a href=https://github.com/plougher/squashfs-tools><code>squashfs-tools</code></a><ul><li><code>zypper in squashfs</code> on SLES or openSUSE</li></ul></li><li><a href=https://dev.lovelyhq.com/libburnia/web/wiki/Xorriso><code>xorriso</code></a><ul><li><code>zypper in xorriso</code> on SLES or openSUSE</li></ul></li><li><code>yq</code> (<a href=https://github.com/mikefarah/yq/releases>version <code>4.x</code></a>), installed via <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packages/toolchain/yq>packages/toolchain/yq</a> (optional)</li><li><a href=https://stedolan.github.io/jq><code>jq</code></a>, installed via <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packages/utils/jq>packages/utils/jq</a> (optional)</li></ul><p><em>Note</em>: Running <code>make</code> deps will install only <code>luet</code>, <code>luet-makeiso</code>, <code>yq</code> and <code>jq</code>. <code>squashfs-tools</code> and <code>xorriso</code> needs to be provided by the OS.</p><h3 id=manually-install-dependencies>Manually install dependencies</h3><p>To install luet locally, you can also run as root:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># curl https://raw.githubusercontent.com/rancher-sandbox/cOS-toolkit/master/scripts/get_luet.sh | sh</span>
</code></pre></div><p>or build <a href=https://github.com/mudler/luet>luet from source</a>).</p><p>You can find more luet components in the official <a href=https://github.com/Luet-lab/luet-repo>Luet repository</a>.</p><h4 id=luet-makeiso>luet-makeiso</h4><p><code>luet-makeiso</code> comes <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packages/toolchain/luet-makeiso>with cOS-toolkit</a>
and can be installed with <code>luet</code> locally:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; luet install -y toolchain/luet-makeiso
</code></pre></div><p>You can also grab the binary from <a href=https://github.com/mudler/luet-makeiso>luet-makeiso</a> releases.</p><h4 id=yq-and-jq>yq and jq</h4><p><code>yq</code> (version <code>4.x</code>) and <code>jq</code> are used to retrieve the list of
packages to build in order to produce the final ISOs. Those are not
strictly required, see the Note below.</p><p>They are installable with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; luet install -y utils/jq toolchain/yq
</code></pre></div><p><em>Note</em>: <code>yq</code> and <code>jq</code> are just used to generate the list of packages to build, and you don&rsquo;t need to have them installed if you manually specify the packages to be compiled.</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2021 SUSE LLC All Rights Reserved</small>
<small class=ml-1><a href=https://www.suse.com/company/legal/ target=_blank rel=noopener>Privacy Policy</a></small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=https://rancher-sandbox.github.io/cos-toolkit-docs/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script><script src=https://rancher-sandbox.github.io/cos-toolkit-docs/js/prism.js></script></body></html>